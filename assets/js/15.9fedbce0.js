(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{481:function(t,s,a){t.exports=a.p+"assets/img/code-sleep-1.23ac80ea.gif"},482:function(t,s,a){t.exports=a.p+"assets/img/code-sleep-2.91527783.gif"},483:function(t,s,a){t.exports=a.p+"assets/img/code-sleep.e1dd224f.gif"},583:function(t,s,a){"use strict";a.r(s);var n=a(55),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"js-实现-sleep-功能"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#js-实现-sleep-功能"}},[t._v("#")]),t._v(" JS 实现 Sleep 功能")]),t._v(" "),n("p",[t._v("这其实是一个很有意思的题目，因为像一些编程语言中提供了类似休眠的方法，比如"),n("code",[t._v("java")]),t._v("的"),n("code",[t._v("Thread.sleep(3000)")]),t._v("，就是休息3秒。在js中虽然没有直接提供，但是我们可以通过一些"),n("code",[t._v("hack")]),t._v("的手段来实现这个有趣的功能。")]),t._v(" "),n("h2",{attrs:{id:"暴力版"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#暴力版"}},[t._v("#")]),t._v(" 暴力版")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sleep")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ms")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" now "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Date"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" Date"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" now "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<=")]),t._v(" ms"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sleep")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("3000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nconsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("info")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hello'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n")])])]),n("p",[t._v("先来看一下效果")]),t._v(" "),n("p",[n("img",{attrs:{src:a(481),alt:"sleep"}})]),t._v(" "),n("p",[t._v("我们来分析一下代码，它的机制就是来一段循环，但是这个循环条件是跟我们的当前时间有关的。我们一开始定义了一个当前时间"),n("code",[t._v("now")]),t._v("，接着判断最新的时间"),n("code",[t._v("Date.now()")]),t._v("与之前的时间的大小，如果小于休眠时间的话，继续循环，直到大于休眠时间为止才不循环了。")]),t._v(" "),n("p",[t._v("说实话，这个想法很巧妙，但是呢，实现的效果却很不好，因为大量的循环会让一些浏览器“卡死”。我们在这段循环中加入一个计数器，看看到底循环了多少次：")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sleep")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ms")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" count "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" now "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Date"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" Date"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" now "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<=")]),t._v(" ms"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("info")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("count"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sleep")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("3000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nconsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("info")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hello'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[t._v("执行结果：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(482),alt:"sleep"}})]),t._v(" "),n("p",[n("strong",[t._v("震惊！竟然有3万多次！所以这个方法千万不要在生产环境用！")])]),t._v(" "),n("h2",{attrs:{id:"优雅版-🌟"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#优雅版-🌟"}},[t._v("#")]),t._v(" 优雅版 🌟")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sleep")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ms")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Promise")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("r")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("r"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ms"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sleep")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("3000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nconsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("info")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hello'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[t._v("我们在Chrome上看看结果：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(483),alt:"sleep"}})]),t._v(" "),n("p",[t._v("简单分析一下代码，我们执行"),n("code",[t._v("await sleep(30000)")]),t._v("时，会去执行"),n("code",[t._v("sleep")]),t._v("方法，我们知道，"),n("code",[t._v("await")]),t._v("跟的是一个"),n("code",[t._v("Promise")]),t._v("并且这个"),n("code",[t._v("Promise")]),t._v("是"),n("code",[t._v("pending")]),t._v("状态的话，那么"),n("code",[t._v("await")]),t._v("后面的代码都不会执行，所以就相当于休眠了。而我们的"),n("code",[t._v("sleep")]),t._v("函数中，返回的"),n("code",[t._v("Promise")]),t._v("，会在"),n("code",[t._v("3000ms")]),t._v("，也就是指定的睡眠时间之后被"),n("code",[t._v("resolve")]),t._v("，所以三秒后"),n("code",[t._v("await")]),t._v("后面的"),n("code",[t._v("Promise")]),t._v("状态改变，就继续往下执行了，打印"),n("code",[t._v("hello")]),t._v("。")]),t._v(" "),n("p",[t._v("由于这种方式几乎没有什么副作用，而且长得也好看，所以是目前的最佳方案。")]),t._v(" "),n("h2",{attrs:{id:"ajax-版"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ajax-版"}},[t._v("#")]),t._v(" AJAX 版")]),t._v(" "),n("p",[t._v("这个方法我也是看别人想到的，觉得真的跟脑筋急转弯一样的。我们知道"),n("code",[t._v("XHR")]),t._v("对象发出的请求，可以支持同步，比如："),n("code",[t._v("xhr.open('GET', '/', false)")]),t._v("，也就是我发完了请求后啥也不做，就等请求回来我再干其他的。基于这个思路，我们也很容易的实现这种"),n("code",[t._v("sleep")]),t._v("的功能。利用网络的延迟来实现休眠的功能也是一个思路，但是 它有两个缺点：")]),t._v(" "),n("ol",[n("li",[t._v("无法设置固定的超时时长（"),n("code",[t._v("timeout")]),t._v("属性是不可以设置在同步请求上的）")]),t._v(" "),n("li",[t._v("对服务器的压力大，并且如果你频繁调用这种无谓请求的话，本身也是一种资源的浪费")])])])}),[],!1,null,null,null);s.default=e.exports}}]);