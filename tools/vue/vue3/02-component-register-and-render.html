<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一个简单的例子 | Jerry 个人博客</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="icon" href="/logo.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <script>
      (function() {
        var mta = document.createElement("script");
        mta.src = "//pingjs.qq.com/h5/stats.js?v2.0.4";
        mta.setAttribute("name", "MTAH5");
        mta.setAttribute("sid", "500708667");
        mta.setAttribute("cid", "500708668");
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(mta, s);
      })();
    </script>
    <script src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <meta name="description" content="Jerry's blog">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    <link rel="preload" href="/assets/css/0.styles.06744937.css" as="style"><link rel="preload" href="/assets/js/app.60e74413.js" as="script"><link rel="preload" href="/assets/js/14.69f023c0.js" as="script"><link rel="preload" href="/assets/js/2.720ba71e.js" as="script"><link rel="preload" href="/assets/js/19.e11c0116.js" as="script"><link rel="prefetch" href="/assets/js/10.4356ad27.js"><link rel="prefetch" href="/assets/js/100.c99580b9.js"><link rel="prefetch" href="/assets/js/101.356781a9.js"><link rel="prefetch" href="/assets/js/11.b045add9.js"><link rel="prefetch" href="/assets/js/12.aeedaf60.js"><link rel="prefetch" href="/assets/js/13.fb627b38.js"><link rel="prefetch" href="/assets/js/15.9fedbce0.js"><link rel="prefetch" href="/assets/js/16.1a7de72a.js"><link rel="prefetch" href="/assets/js/17.fa224a6a.js"><link rel="prefetch" href="/assets/js/18.1a72bef8.js"><link rel="prefetch" href="/assets/js/20.6a6f73dd.js"><link rel="prefetch" href="/assets/js/21.56a777d3.js"><link rel="prefetch" href="/assets/js/22.6773a84c.js"><link rel="prefetch" href="/assets/js/23.136061fb.js"><link rel="prefetch" href="/assets/js/24.7d1837f0.js"><link rel="prefetch" href="/assets/js/25.31ab58df.js"><link rel="prefetch" href="/assets/js/26.a5e7b497.js"><link rel="prefetch" href="/assets/js/27.9609abfa.js"><link rel="prefetch" href="/assets/js/28.bbb9cd06.js"><link rel="prefetch" href="/assets/js/29.8892b17d.js"><link rel="prefetch" href="/assets/js/3.b7eab624.js"><link rel="prefetch" href="/assets/js/30.74b203cc.js"><link rel="prefetch" href="/assets/js/31.f8502b39.js"><link rel="prefetch" href="/assets/js/32.4a6fdb4c.js"><link rel="prefetch" href="/assets/js/33.06378ca2.js"><link rel="prefetch" href="/assets/js/34.0060ef5f.js"><link rel="prefetch" href="/assets/js/35.1635574b.js"><link rel="prefetch" href="/assets/js/36.ba0ea7aa.js"><link rel="prefetch" href="/assets/js/37.1fe72493.js"><link rel="prefetch" href="/assets/js/38.6140df13.js"><link rel="prefetch" href="/assets/js/39.75defbda.js"><link rel="prefetch" href="/assets/js/4.99432b89.js"><link rel="prefetch" href="/assets/js/40.95f6174a.js"><link rel="prefetch" href="/assets/js/41.edc39790.js"><link rel="prefetch" href="/assets/js/42.9dcf7ed0.js"><link rel="prefetch" href="/assets/js/43.027f7ff4.js"><link rel="prefetch" href="/assets/js/44.a7fa2c02.js"><link rel="prefetch" href="/assets/js/45.3bd0a364.js"><link rel="prefetch" href="/assets/js/46.6682a04b.js"><link rel="prefetch" href="/assets/js/47.a61c377c.js"><link rel="prefetch" href="/assets/js/48.1f4bbd9a.js"><link rel="prefetch" href="/assets/js/49.7f23a237.js"><link rel="prefetch" href="/assets/js/5.406f67b1.js"><link rel="prefetch" href="/assets/js/50.2a56a559.js"><link rel="prefetch" href="/assets/js/51.bb97c3da.js"><link rel="prefetch" href="/assets/js/52.446d5740.js"><link rel="prefetch" href="/assets/js/53.e8184b0c.js"><link rel="prefetch" href="/assets/js/54.c9a5e3ed.js"><link rel="prefetch" href="/assets/js/55.97bb4c63.js"><link rel="prefetch" href="/assets/js/56.cb3d973f.js"><link rel="prefetch" href="/assets/js/57.37f3fb00.js"><link rel="prefetch" href="/assets/js/58.0d7c2f4b.js"><link rel="prefetch" href="/assets/js/59.4a2f6def.js"><link rel="prefetch" href="/assets/js/6.95b28193.js"><link rel="prefetch" href="/assets/js/60.b2a604a0.js"><link rel="prefetch" href="/assets/js/61.debbb7b9.js"><link rel="prefetch" href="/assets/js/62.0bd56b0e.js"><link rel="prefetch" href="/assets/js/63.57bf8cbe.js"><link rel="prefetch" href="/assets/js/64.41c1fb35.js"><link rel="prefetch" href="/assets/js/65.f53d1b42.js"><link rel="prefetch" href="/assets/js/66.566689b9.js"><link rel="prefetch" href="/assets/js/67.f5cf077d.js"><link rel="prefetch" href="/assets/js/68.95bc1b6c.js"><link rel="prefetch" href="/assets/js/69.bdc844a1.js"><link rel="prefetch" href="/assets/js/7.6619bfc9.js"><link rel="prefetch" href="/assets/js/70.94a6894a.js"><link rel="prefetch" href="/assets/js/71.4e9ddb06.js"><link rel="prefetch" href="/assets/js/72.2c8413d7.js"><link rel="prefetch" href="/assets/js/73.64fdac61.js"><link rel="prefetch" href="/assets/js/74.a6f66ae3.js"><link rel="prefetch" href="/assets/js/75.9e940b3a.js"><link rel="prefetch" href="/assets/js/76.7e0d8e19.js"><link rel="prefetch" href="/assets/js/77.c67342fb.js"><link rel="prefetch" href="/assets/js/78.a5bd97d1.js"><link rel="prefetch" href="/assets/js/79.3a3e3541.js"><link rel="prefetch" href="/assets/js/8.d0a8a3ed.js"><link rel="prefetch" href="/assets/js/80.97620f66.js"><link rel="prefetch" href="/assets/js/81.0d8341aa.js"><link rel="prefetch" href="/assets/js/82.0d309601.js"><link rel="prefetch" href="/assets/js/83.6123aeae.js"><link rel="prefetch" href="/assets/js/84.00b21399.js"><link rel="prefetch" href="/assets/js/85.d22ae4f9.js"><link rel="prefetch" href="/assets/js/86.a79065fe.js"><link rel="prefetch" href="/assets/js/87.01664722.js"><link rel="prefetch" href="/assets/js/88.1cb8429e.js"><link rel="prefetch" href="/assets/js/89.a36be8c5.js"><link rel="prefetch" href="/assets/js/9.f2277063.js"><link rel="prefetch" href="/assets/js/90.ebfec47e.js"><link rel="prefetch" href="/assets/js/91.47f73c78.js"><link rel="prefetch" href="/assets/js/92.4ae86837.js"><link rel="prefetch" href="/assets/js/93.8bbf0769.js"><link rel="prefetch" href="/assets/js/94.8f1e3309.js"><link rel="prefetch" href="/assets/js/95.ea1c2085.js"><link rel="prefetch" href="/assets/js/96.08475163.js"><link rel="prefetch" href="/assets/js/97.a8c7442e.js"><link rel="prefetch" href="/assets/js/98.9d7ce618.js"><link rel="prefetch" href="/assets/js/99.eb0c7f6a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.06744937.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Jerry 个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/basic/js/index.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/basic/css/index.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/basic/html/index.html" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/http/index.html" class="nav-link">
  HTTP
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue 系列" class="dropdown-title"><span class="title">Vue 系列</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tools/vue/vue2/index.html" class="nav-link">
  Vue 2
</a></li><li class="dropdown-item"><!----> <a href="/tools/vue/vue3/index.html" class="nav-link">
  Vue 3
</a></li><li class="dropdown-item"><!----> <a href="/tools/vue/vuex/index.html" class="nav-link">
  Vuex
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="源码精读" class="dropdown-title"><span class="title">源码精读</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tools/snabbdom/index.html" class="nav-link">
  Snabbdom
</a></li><li class="dropdown-item"><!----> <a href="/tools/axios/index.html" class="nav-link">
  Axios
</a></li></ul></div></div><div class="nav-item"><a href="/backend/" class="nav-link">
  技能拓展
</a></div><div class="nav-item"><a href="/tools/webpack/" class="nav-link">
  Webpack
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  About Me
</a></div> <a href="https://github.com/JerryYuanJ/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/basic/js/index.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/basic/css/index.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/basic/html/index.html" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/http/index.html" class="nav-link">
  HTTP
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue 系列" class="dropdown-title"><span class="title">Vue 系列</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tools/vue/vue2/index.html" class="nav-link">
  Vue 2
</a></li><li class="dropdown-item"><!----> <a href="/tools/vue/vue3/index.html" class="nav-link">
  Vue 3
</a></li><li class="dropdown-item"><!----> <a href="/tools/vue/vuex/index.html" class="nav-link">
  Vuex
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="源码精读" class="dropdown-title"><span class="title">源码精读</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tools/snabbdom/index.html" class="nav-link">
  Snabbdom
</a></li><li class="dropdown-item"><!----> <a href="/tools/axios/index.html" class="nav-link">
  Axios
</a></li></ul></div></div><div class="nav-item"><a href="/backend/" class="nav-link">
  技能拓展
</a></div><div class="nav-item"><a href="/tools/webpack/" class="nav-link">
  Webpack
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  About Me
</a></div> <a href="https://github.com/JerryYuanJ/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>初始化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/tools/vue/vue3/00-before.html" class="sidebar-link">写在前面</a></li><li><a href="/tools/vue/vue3/01-init-app.html" class="sidebar-link">Vue 的初始化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>组件化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/tools/vue/vue3/02-component-register-and-render.html" aria-current="page" class="active sidebar-link">组件注册与渲染</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tools/vue/vue3/02-component-register-and-render.html#一个简单的例子" class="sidebar-link">一个简单的例子</a></li><li class="sidebar-sub-header"><a href="/tools/vue/vue3/02-component-register-and-render.html#组件注册" class="sidebar-link">组件注册</a></li><li class="sidebar-sub-header"><a href="/tools/vue/vue3/02-component-register-and-render.html#mount-函数" class="sidebar-link">mount 函数</a></li><li class="sidebar-sub-header"><a href="/tools/vue/vue3/02-component-register-and-render.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/tools/vue/vue3/02-component-lifecycle.html" class="sidebar-link">生命周期</a></li><li><a href="/tools/vue/vue3/02-component-async.html" class="sidebar-link">异步组件</a></li><li><a href="/tools/vue/vue3/02-component-internal.html" class="sidebar-link">内置组件</a></li></ul></section></li></ul> <div class="adsense-content" data-v-8d82fd90><div style="padding: 2rem" data-v-8d82fd90></div></div></aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="一个简单的例子"><a href="#一个简单的例子" class="header-anchor">#</a> 一个简单的例子</h2> <p>我们在上一节的例子上做点修改，增加一个简单的 <code>hello-world</code> 组件。它接收一个名为 message 的 prop，并且我们在页面上引用这个组件。</p> <div class="language-html extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br></div><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hello-world</span> <span class="token attr-name">:message</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>message<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hello-world</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./vue.esm-browser.js&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        message<span class="token operator">:</span> <span class="token string">&quot;Vue Rocks!&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  app<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'hello-world'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    template<span class="token operator">:</span> <span class="token string">'&lt;h1&gt;{{ message }}&lt;/h1&gt;'</span><span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token punctuation">{</span>
      message<span class="token operator">:</span> String
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  app<span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>

</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><img src="/assets/img/02-comp-reg.cef75411.png" alt="component register"></p> <p>可以看到，组件正确的渲染到了页面上。接下来我们就来看看组件是如何注册和渲染的。</p> <h2 id="组件注册"><a href="#组件注册" class="header-anchor">#</a> 组件注册</h2> <p>还记得上一章我们介绍的 <code>createAppAPI</code> 吗？当时我们讲了 <code>createApp</code> 函数返回的对象实例中，包含很多方法，其中有一个就是用来注册组件的，我们来看一下它的实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">component</span><span class="token punctuation">(</span>name<span class="token operator">:</span> string<span class="token punctuation">,</span> component<span class="token operator">?</span><span class="token operator">:</span> Component<span class="token punctuation">)</span><span class="token operator">:</span> any <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">validateComponentName</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> context<span class="token punctuation">.</span>config<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> context<span class="token punctuation">.</span>components<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> context<span class="token punctuation">.</span>components<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Component &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; has already been registered in target app.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  context<span class="token punctuation">.</span>components<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> component
  <span class="token keyword">return</span> app
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>它的实现非常简单。<code>component</code> 函数接收两个参数，第一个是组件名，第二个是组件定义对象。如果只传了第一个参数的话，那么就看作是获取组件对象的一个 getter 函数。如果都传递了，那么将组件名作为 key，组件定义作为值，设置到 <code>context.components</code> 对象上。其中，context 是当前 Vue 实例 app 的上下文对象，我们可以通过 <code>app._context</code> 访问到，可以打印一下看看（这里打印的是没有 mount 之前的对象）：</p> <p><img src="/assets/img/02-comp-func.ccee9bea.png" alt="app._context"></p> <p>可以看到，此时的 <code>app._context</code> 对象已经包含了定义的组件了，那么可以推测，负责组件的 <strong>模版编译</strong>、<strong>VNode 渲染</strong> 等工作的逻辑，都是在接下来的 mount 函数中处理的。</p> <h2 id="mount-函数"><a href="#mount-函数" class="header-anchor">#</a> mount 函数</h2> <p>上一章我们简单介绍过 mount 函数，知道它是通过装饰器模式做了功能增强，而原始的 mount 函数我们之前也简单的分析过，这里就不多赘述了。在 mount 函数中，重要的步骤有如下两个：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1. 创建 Vnode</span>
<span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>
  rootComponent <span class="token keyword">as</span> ConcreteComponent<span class="token punctuation">,</span>
  rootProps
<span class="token punctuation">)</span>

<span class="token comment">// 2. 渲染</span>
<span class="token function">render</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> rootContainer<span class="token punctuation">)</span>
</code></pre></div><p>由于我们的例子比较简单，所以这了的 createVNode 函数也很简单，没有太多的分支逻辑可以走，所以它此时的值基本上都是保持着初始值：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  anchor<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  appContext<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  children<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  component<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  dirs<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  dynamicChildren<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  dynamicProps<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  el<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  key<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  patchFlag<span class="token operator">:</span> <span class="token number">0</span>
  props<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  ref<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  scopeId<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  shapeFlag<span class="token operator">:</span> <span class="token number">4</span>
  ssContent<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  ssFallback<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  staticCount<span class="token operator">:</span> <span class="token number">0</span>
  suspense<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  target<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  targetAnchor<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  transition<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  __v_isVNode<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  __v_skip<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token comment">// 注意，这里的 type 其实就是我们 createApp 传进去的参数。</span>
  <span class="token comment">// template 属性还记得是从哪里来的吗？</span>
  type<span class="token operator">:</span> <span class="token punctuation">{</span>
    template<span class="token operator">:</span> <span class="token string">&quot;↵    &lt;hello-world :message=&quot;</span>message<span class="token string">&quot;&gt;&lt;/hello-world&gt;↵  &quot;</span><span class="token punctuation">,</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        message<span class="token operator">:</span> <span class="token string">&quot;Vue Rocks!&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个对象会在下面很长时间内用到，所以你要有一个大概的印象。这里值得一提的是 <code>shapeFlag</code>，它的值是通过一系列的三元运算得来的：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> shapeFlag <span class="token operator">=</span> <span class="token function">isString</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
    <span class="token operator">?</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ELEMENT</span>
    <span class="token operator">:</span> __FEATURE_SUSPENSE__ <span class="token operator">&amp;&amp;</span> <span class="token function">isSuspense</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
      <span class="token operator">?</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">SUSPENSE</span>
      <span class="token operator">:</span> <span class="token function">isTeleport</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
        <span class="token operator">?</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TELEPORT</span>
        <span class="token operator">:</span> <span class="token function">isObject</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token comment">// 对象类型 =&gt; 组件</span>
          <span class="token operator">?</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">STATEFUL_COMPONENT</span>
          <span class="token operator">:</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
            <span class="token operator">?</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">FUNCTIONAL_COMPONENT</span>
            <span class="token operator">:</span> <span class="token number">0</span>
</code></pre></div><p><code>shapeFlag</code> 的作用体现在渲染的过程中。简言之，它是方便我们判断一个元素的类型，比如是普通的 DOM 元素，还是组件，还是 Suspense 等。我们后面会详细介绍。</p> <p>有了 VNode 以后，接下来就要开始渲染了。这里的 render 函数，是在 <code>baseCreateRenderer</code> 中定义的，通过函数参数的形式传递给了 <code>createAppAPI</code> 函数。来看一下它的定义（runtime-core/src/renderer.ts）：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> render<span class="token operator">:</span> <span class="token function-variable function">RootRenderFunction</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>container<span class="token punctuation">.</span>_vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">unmount</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>_vnode<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">patch</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>_vnode <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">flushPostFlushCbs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  container<span class="token punctuation">.</span>_vnode <span class="token operator">=</span> vnode
<span class="token punctuation">}</span>
</code></pre></div><p>它接收两个参数，第一个参数表示要渲染的 VNode，第二个参数表示渲染的目标容器。由于我们的 vnode 不是 null，所以此时会执行 patch 逻辑。此时由于是第一次渲染，所以我们的 container._vnode 没有值，所以 patch 的第一个参数是 null。patch 函数也在当前文件中定义，它的实现较长，老样子这里我精简一下，只分析能执行到的代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> patch<span class="token operator">:</span> <span class="token function-variable function">PatchFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token parameter">n1<span class="token punctuation">,</span>
  n2<span class="token punctuation">,</span>
  container<span class="token punctuation">,</span>
  anchor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  parentComponent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  parentSuspense <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  isSVG <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  optimized <span class="token operator">=</span> <span class="token boolean">false</span></span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ... 其他逻辑</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> shapeFlag <span class="token punctuation">}</span> <span class="token operator">=</span> n2
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> Text<span class="token operator">:</span>  <span class="token comment">// 处理文本节点</span>
    <span class="token keyword">case</span> Comment<span class="token operator">:</span> <span class="token comment">// 处理注释节点</span>
    <span class="token keyword">case</span> Static<span class="token operator">:</span> <span class="token comment">// 处理静态节点</span>
    <span class="token keyword">case</span> Fragment<span class="token operator">:</span> <span class="token comment">// 处理片段</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 处理元素节点 ...</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">processComponent</span><span class="token punctuation">(</span>
          n1<span class="token punctuation">,</span> <span class="token comment">// null</span>
          n2<span class="token punctuation">,</span> <span class="token comment">// vnode</span>
          container<span class="token punctuation">,</span> <span class="token comment">// div#app</span>
          anchor<span class="token punctuation">,</span>
          parentComponent<span class="token punctuation">,</span>
          parentSuspense<span class="token punctuation">,</span>
          isSVG<span class="token punctuation">,</span>
          optimized
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TELEPORT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 处理 teleport</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>__FEATURE_SUSPENSE__ <span class="token operator">&amp;&amp;</span> shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">SUSPENSE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 处理 suspense</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Invalid VNode type:'</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">typeof</span> type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// set ref</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ref <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> parentComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setRef</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> n1 <span class="token operator">&amp;&amp;</span> n1<span class="token punctuation">.</span>ref<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> n2<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到，这里执行了 <code>processComponent</code> 函数。这个 patch 可以看作是一个逻辑分发器。我们来看一下 <code>processComponent</code> 的实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">processComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token parameter">n1<span class="token operator">:</span> VNode <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  n2<span class="token operator">:</span> VNode<span class="token punctuation">,</span>
  container<span class="token operator">:</span> RendererElement<span class="token punctuation">,</span>
  anchor<span class="token operator">:</span> RendererNode <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  parentComponent<span class="token operator">:</span> ComponentInternalInstance <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  parentSuspense<span class="token operator">:</span> SuspenseBoundary <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  isSVG<span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  optimized<span class="token operator">:</span> boolean</span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// n1 为 null 表示是第一次渲染，那么执行 挂载 逻辑</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n1 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n2<span class="token punctuation">.</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">COMPONENT_KEPT_ALIVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 处理 keep-alive 的逻辑</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 挂载组件</span>
      <span class="token function">mountComponent</span><span class="token punctuation">(</span>n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> isSVG<span class="token punctuation">,</span> optimized<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 否则说明是更新</span>
    <span class="token function">updateComponent</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> optimized<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里也是一个简单的逻辑分发。本例中我们 n1 为 null，所以会执行 <code>mountComponent</code> 来挂载，继续往下看它的实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> mountComponent<span class="token operator">:</span> <span class="token function-variable function">MountComponentFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token parameter">initialVNode<span class="token punctuation">,</span>
  container<span class="token punctuation">,</span>
  anchor<span class="token punctuation">,</span>
  parentComponent<span class="token punctuation">,</span>
  parentSuspense<span class="token punctuation">,</span>
  isSVG<span class="token punctuation">,</span>
  optimized</span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> instance<span class="token operator">:</span> ComponentInternalInstance <span class="token operator">=</span> <span class="token punctuation">(</span>initialVNode<span class="token punctuation">.</span>component <span class="token operator">=</span> <span class="token function">createComponentInstance</span><span class="token punctuation">(</span>
    initialVNode<span class="token punctuation">,</span>
    parentComponent<span class="token punctuation">,</span>
    parentSuspense
  <span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// dev 下的一些处理 ...</span>
  <span class="token comment">// keep-alive 的一些处理 ...</span>

  <span class="token function">setupComponent</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span>

  <span class="token comment">// 处理 suspense 的逻辑，由于此时我们的 aysncDep 为 null，所以这段逻辑也不会走</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__FEATURE_SUSPENSE__ <span class="token operator">&amp;&amp;</span> instance<span class="token punctuation">.</span>asyncDep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    parentSuspense <span class="token operator">&amp;&amp;</span> parentSuspense<span class="token punctuation">.</span><span class="token function">registerDep</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> setupRenderEffect<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>initialVNode<span class="token punctuation">.</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> placeholder <span class="token operator">=</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span>subTree <span class="token operator">=</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>Comment<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">processCommentNode</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> placeholder<span class="token punctuation">,</span> container<span class="token operator">!</span><span class="token punctuation">,</span> anchor<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token function">setupRenderEffect</span><span class="token punctuation">(</span>
    instance<span class="token punctuation">,</span> initialVNode<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> isSVG<span class="token punctuation">,</span> optimized
  <span class="token punctuation">)</span>

<span class="token punctuation">}</span>
</code></pre></div><p>这里主要做了三件事：</p> <ol><li>创建组件实例：<code>createComponentInstance</code>；<br></li> <li>设置组件：<code>setupComponent</code>；<br></li> <li>设置渲染副作用：<code>setupRenderEffect</code></li></ol> <p>我们先看第一步，它位于 packages/runtime-core/src/component.ts 中：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createComponentInstance</span><span class="token punctuation">(</span>
  <span class="token parameter">vnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span>
  parent<span class="token operator">:</span> ComponentInternalInstance <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  suspense<span class="token operator">:</span> SuspenseBoundary <span class="token operator">|</span> <span class="token keyword">null</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> type <span class="token operator">=</span> vnode<span class="token punctuation">.</span>type <span class="token keyword">as</span> ConcreteComponent
  <span class="token comment">// 获取 appContext 对象</span>
  <span class="token comment">// 由于我们此时的 parent 为 null，所以这里的 appContext 就是当前 vnode 的 appContext 对象</span>
  <span class="token keyword">const</span> appContext <span class="token operator">=</span>
    <span class="token punctuation">(</span>parent <span class="token operator">?</span> parent<span class="token punctuation">.</span>appContext <span class="token operator">:</span> vnode<span class="token punctuation">.</span>appContext<span class="token punctuation">)</span> <span class="token operator">||</span> emptyAppContext

  <span class="token keyword">const</span> instance<span class="token operator">:</span> ComponentInternalInstance <span class="token operator">=</span> <span class="token punctuation">{</span>
    uid<span class="token operator">:</span> uid<span class="token operator">++</span><span class="token punctuation">,</span> <span class="token comment">// 组件id</span>
    vnode<span class="token punctuation">,</span> <span class="token comment">// 组件对于的 vnode</span>
    type<span class="token punctuation">,</span> <span class="token comment">// 组件类型，这里是 { template: xxx, data() { ... } }</span>
    parent<span class="token punctuation">,</span> <span class="token comment">// 父</span>
    appContext<span class="token punctuation">,</span> <span class="token comment">// app 上下文</span>
    root<span class="token operator">:</span> <span class="token keyword">null</span><span class="token operator">!</span><span class="token punctuation">,</span> <span class="token comment">// 根</span>
    next<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// ？</span>
    subTree<span class="token operator">:</span> <span class="token keyword">null</span><span class="token operator">!</span><span class="token punctuation">,</span> <span class="token comment">// 子树，会在组件创建后立即赋值</span>
    update<span class="token operator">:</span> <span class="token keyword">null</span><span class="token operator">!</span><span class="token punctuation">,</span> <span class="token comment">// 更新函数，会在组件创建后立即赋值</span>
    render<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 渲染函数</span>
    proxy<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 代理对象</span>
    exposed<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 对外暴露的对象</span>
    withProxy<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">//  with块下的代理对象</span>
    effects<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 副作用</span>
    provides<span class="token operator">:</span> parent <span class="token operator">?</span> parent<span class="token punctuation">.</span>provides <span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>appContext<span class="token punctuation">.</span>provides<span class="token punctuation">)</span><span class="token punctuation">,</span>
    accessCache<span class="token operator">:</span> <span class="token keyword">null</span><span class="token operator">!</span><span class="token punctuation">,</span> <span class="token comment">// 访问缓存</span>
    renderCache<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 渲染缓存</span>

    <span class="token comment">// local resovled assets</span>
    components<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 子（局部）组件</span>
    directives<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// （局部）指令</span>

    <span class="token comment">// propsOptions: 本例中是 [] 空数组</span>
    propsOptions<span class="token operator">:</span> <span class="token function">normalizePropsOptions</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> appContext<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// emitsOptions: 本例中是 null</span>
    emitsOptions<span class="token operator">:</span> <span class="token function">normalizeEmitsOptions</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> appContext<span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">// emit</span>
    emit<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token keyword">as</span> any<span class="token punctuation">,</span> <span class="token comment">// 是个函数，在下面赋值</span>
    emitted<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

    <span class="token comment">// 状态相关的属性</span>
    ctx<span class="token operator">:</span> <span class="token constant">EMPTY_OBJ</span><span class="token punctuation">,</span>
    data<span class="token operator">:</span> <span class="token constant">EMPTY_OBJ</span><span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token constant">EMPTY_OBJ</span><span class="token punctuation">,</span>
    attrs<span class="token operator">:</span> <span class="token constant">EMPTY_OBJ</span><span class="token punctuation">,</span>
    slots<span class="token operator">:</span> <span class="token constant">EMPTY_OBJ</span><span class="token punctuation">,</span>
    refs<span class="token operator">:</span> <span class="token constant">EMPTY_OBJ</span><span class="token punctuation">,</span>
    setupState<span class="token operator">:</span> <span class="token constant">EMPTY_OBJ</span><span class="token punctuation">,</span>
    setupContext<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

    <span class="token comment">// suspense related</span>
    suspense<span class="token punctuation">,</span>
    suspenseId<span class="token operator">:</span> suspense <span class="token operator">?</span> suspense<span class="token punctuation">.</span>pendingId <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    asyncDep<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    asyncResolved<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>

    <span class="token comment">// 生命周期相关属性和钩子</span>
    isMounted<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    isUnmounted<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    isDeactivated<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    bc<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    c<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    bm<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    m<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    bu<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    u<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    um<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    bum<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    da<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    a<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    rtg<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    rtc<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    ec<span class="token operator">:</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    instance<span class="token punctuation">.</span>ctx <span class="token operator">=</span> <span class="token function">createRenderContext</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将当前组件实例对象作为 ctx 属性存下来</span>
    instance<span class="token punctuation">.</span>ctx <span class="token operator">=</span> <span class="token punctuation">{</span> _<span class="token operator">:</span> instance <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  instance<span class="token punctuation">.</span>root <span class="token operator">=</span> parent <span class="token operator">?</span> parent<span class="token punctuation">.</span>root <span class="token operator">:</span> instance
  instance<span class="token punctuation">.</span>emit <span class="token operator">=</span> <span class="token function">emit</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> instance<span class="token punctuation">)</span>

  <span class="token keyword">return</span> instance
<span class="token punctuation">}</span>
</code></pre></div><p>它就是简单的返回了一个组件实例对象，很多属性在初始化的时候都没有值，它们会在生命周期的不同阶段赋值。这里有两个函数提一下：<code>normalizePropsOptions</code> 和 <code>normalizeEmitsOptions</code>，我们会在执行到 <code>hello-world</code> 组件初始化的再介绍。</p> <p>此时，我们已经拿到了 component 实例了，然后会把它赋值给 <code>initialVNode</code>（也就是一开始的 vnode） 的 component 属性。接下来，要执行 <code>setupComponent(instance)</code> 来初始化我们的 component，来看一下它的定义：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setupComponent</span><span class="token punctuation">(</span>
  <span class="token parameter">instance<span class="token operator">:</span> ComponentInternalInstance<span class="token punctuation">,</span>
  isSSR <span class="token operator">=</span> <span class="token boolean">false</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  isInSSRComponentSetup <span class="token operator">=</span> isSSR

  <span class="token keyword">const</span> <span class="token punctuation">{</span> props<span class="token punctuation">,</span> children <span class="token punctuation">}</span> <span class="token operator">=</span> instance<span class="token punctuation">.</span>vnode
  <span class="token keyword">const</span> isStateful <span class="token operator">=</span> <span class="token function">isStatefulComponent</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span>
  <span class="token function">initProps</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> props<span class="token punctuation">,</span> isStateful<span class="token punctuation">,</span> isSSR<span class="token punctuation">)</span>
  <span class="token function">initSlots</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> children<span class="token punctuation">)</span>

  <span class="token keyword">const</span> setupResult <span class="token operator">=</span> isStateful
    <span class="token operator">?</span> <span class="token function">setupStatefulComponent</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> isSSR<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token keyword">undefined</span>
  isInSSRComponentSetup <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token keyword">return</span> setupResult
<span class="token punctuation">}</span>

<span class="token comment">// 判断是否是有状态的组件</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isStatefulComponent</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token operator">:</span> ComponentInternalInstance</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> instance<span class="token punctuation">.</span>vnode<span class="token punctuation">.</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">STATEFUL_COMPONENT</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里首先获取了 vnode 上的 props 和 children 属性，本例中这两个都是 null（注意，这里还没有分析到 <code>hello-world</code> 组件，所以不要弄混淆了）。</p> <p>接着判断了当前组件是否是有状态的组件，这个之前提到过，它的 shapeFlag 为 <code>ShapeFlags.STATEFUL_COMPONENT</code>，所以是有状态组件，即 isStateful 是一个 truthy 的值。接着它调用了 <code>initProps</code> 来初始化 props，他的定义在 packages/runtime-core/src/componentProps.ts 中：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initProps</span><span class="token punctuation">(</span>
  instance<span class="token operator">:</span> ComponentInternalInstance<span class="token punctuation">,</span>
  rawProps<span class="token operator">:</span> Data <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  isStateful<span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token comment">// result of bitwise flag comparison</span>
  isSSR <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> props<span class="token operator">:</span> Data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">const</span> attrs<span class="token operator">:</span> Data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// 设置 attrs.__vInternal = 1，使用 def（defineProperty）是不想让这个属性被枚举</span>
  <span class="token function">def</span><span class="token punctuation">(</span>attrs<span class="token punctuation">,</span> InternalObjectKey<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token function">setFullProps</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> rawProps<span class="token punctuation">,</span> props<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span>
  
  <span class="token comment">// 开发环境下的校验</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">validateProps</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> instance<span class="token punctuation">)</span> <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isStateful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// stateful</span>
    instance<span class="token punctuation">.</span>props <span class="token operator">=</span> isSSR <span class="token operator">?</span> props <span class="token operator">:</span> <span class="token function">shallowReactive</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instance<span class="token punctuation">.</span>type<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// functional w/ optional props, props === attrs</span>
      instance<span class="token punctuation">.</span>props <span class="token operator">=</span> attrs
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// functional w/ declared props</span>
      instance<span class="token punctuation">.</span>props <span class="token operator">=</span> props
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  instance<span class="token punctuation">.</span>attrs <span class="token operator">=</span> attrs
<span class="token punctuation">}</span>
</code></pre></div><p>这个函数主要作用就是用来初始化 props 的。首先它定义了两个空对象：props 和 attrs，然后给 attrs 添加属性 <code>__vInternal</code>；接着调用 <code>setFullProps</code> 函数来设置 props，由于本例中我们的 rawProps 为 null，并且 instance.propsOptions 为空数组，所以这个函数本质上不会执行实质性的逻辑；然后就是比较重要的一行代码：</p> <div class="language-js extra-class"><pre class="language-js"><code>instance<span class="token punctuation">.</span>props <span class="token operator">=</span> isSSR <span class="token operator">?</span> props <span class="token operator">:</span> <span class="token function">shallowReactive</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>
</code></pre></div><p>我们还没介绍响应式的原理，不过这里你大概可以猜到，这行代码是将 props 转成了响应式的对象。等分析了响应式章节的时候会再介绍的；最后将 attrs 赋值给了当前组件的 attrs 对象。到这里 <code>initProps</code> 就执行完了。稍微回顾一下，<strong>这个函数就是给当前组件实例添加了两个属性：props 和 attrs。</strong></p> <p>回到我们的 <code>setupComponent</code> 函数中来，接下来到了 <code>initSlot</code> 函数了，它的实现也很简单，在 packages/runtime-core/src/componentSlots.ts 中，读者可以自行去看，这里它其实是给当前组件实例添加属性 <strong>slots</strong>，不多赘述了。</p> <p>继续往下的话，会执行到我们的 <code>setupStatefulComponent</code> 函数了，这是个重点。函数也很长，我们看一下精简后的：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">setupStatefulComponent</span><span class="token punctuation">(</span>
  <span class="token parameter">instance<span class="token operator">:</span> ComponentInternalInstance<span class="token punctuation">,</span>
  isSSR<span class="token operator">:</span> boolean</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> Component <span class="token operator">=</span> instance<span class="token punctuation">.</span>type <span class="token keyword">as</span> ComponentOptions
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ... 在开发环境下的一些校验 ... </span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 创建渲染代理属性的缓存</span>
  instance<span class="token punctuation">.</span>accessCache <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token comment">// 创建 instance.ctx 的代理对象，在后面会用到（作为执行的上下文对象）</span>
  instance<span class="token punctuation">.</span>proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> PublicInstanceProxyHandlers<span class="token punctuation">)</span>
  
  <span class="token comment">// 2. call setup()</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> setup <span class="token punctuation">}</span> <span class="token operator">=</span> Component
  <span class="token keyword">if</span> <span class="token punctuation">(</span>setup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 处理 setup 逻辑 ...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">finishComponentSetup</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> isSSR<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个函数也给我们的组件实例添加了一些属性：首先是 accessCache 属性，它的初始值为 null；接着是 proxy 属性，它是一个代理对象，代理的是 instance.ctx 对象，这个对象之前介绍过，在生产环境下，它的初始值为 <code>{ _: instance }</code>，其中 instance 就是当前组件对象，<code>PublicInstanceProxyHandlers</code> 定义在 packages/runtime-core/src/componentPublicInstance.ts 中：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> PublicInstanceProxyHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">has</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代理了它的三个方法，后面用到的时候再介绍。</p> <p>最后会判断有没有定义 setup ，这个是 vue3 的新功能，本例中我们没有使用，所以走不到这里，最终会执行 <code>finishComponentSetup</code> 来结束这次初始化：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">finishComponentSetup</span><span class="token punctuation">(</span>
  <span class="token parameter">instance<span class="token operator">:</span> ComponentInternalInstance<span class="token punctuation">,</span>
  isSSR<span class="token operator">:</span> boolean</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> Component <span class="token operator">=</span> instance<span class="token punctuation">.</span>type <span class="token keyword">as</span> ComponentOptions

  <span class="token comment">// template / render function normalization</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__NODE_JS__ <span class="token operator">&amp;&amp;</span> isSSR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// SSR 相关逻辑 ...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instance<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>compile <span class="token operator">&amp;&amp;</span> Component<span class="token punctuation">.</span>template <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>Component<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 编译生成 render 函数</span>
      Component<span class="token punctuation">.</span>render <span class="token operator">=</span> <span class="token function">compile</span><span class="token punctuation">(</span>Component<span class="token punctuation">.</span>template<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        isCustomElement<span class="token operator">:</span> instance<span class="token punctuation">.</span>appContext<span class="token punctuation">.</span>config<span class="token punctuation">.</span>isCustomElement<span class="token punctuation">,</span>
        delimiters<span class="token operator">:</span> Component<span class="token punctuation">.</span>delimiters
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    instance<span class="token punctuation">.</span>render <span class="token operator">=</span> <span class="token punctuation">(</span>Component<span class="token punctuation">.</span>render <span class="token operator">||</span> <span class="token constant">NOOP</span><span class="token punctuation">)</span> <span class="token keyword">as</span> InternalRenderFunction

    <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span>render<span class="token punctuation">.</span>_rc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      instance<span class="token punctuation">.</span>withProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>
        instance<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span>
        RuntimeCompiledPublicInstanceProxyHandlers
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 兼容 vue2 的 options API</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__FEATURE_OPTIONS_API__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    currentInstance <span class="token operator">=</span> instance
    <span class="token function">pauseTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">applyOptions</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> Component<span class="token punctuation">)</span>
    <span class="token function">resetTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    currentInstance <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// warn missing template/render</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>Component<span class="token punctuation">.</span>render <span class="token operator">&amp;&amp;</span> instance<span class="token punctuation">.</span>render <span class="token operator">===</span> <span class="token constant">NOOP</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 没有定义 template 或者 render 时的一些警告</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>首先执行的逻辑应该是生成 render 函数，它是通过编译模板得到的，关于编译的过程我们会单独在一个章节介绍，你只需要知道，<strong>编译函数的作用是将模板转成 render 函数。</strong> 生成 render 函数后，会赋值给当前组件 Component 和 当前组件实例 instance。我们可以打印一下看看此时的 render 函数长什么样：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">_ctx<span class="token punctuation">,</span> _cache</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">with</span> <span class="token punctuation">(</span>_ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> 
      resolveComponent<span class="token operator">:</span> _resolveComponent<span class="token punctuation">,</span> createVNode<span class="token operator">:</span> _createVNode<span class="token punctuation">,</span> openBlock<span class="token operator">:</span> _openBlock<span class="token punctuation">,</span> createBlock<span class="token operator">:</span> _createBlock 
    <span class="token punctuation">}</span> <span class="token operator">=</span> _Vue

    <span class="token keyword">const</span> _component_hello_world <span class="token operator">=</span> <span class="token function">_resolveComponent</span><span class="token punctuation">(</span><span class="token string">&quot;hello-world&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">_openBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_createBlock</span><span class="token punctuation">(</span>_component_hello_world<span class="token punctuation">,</span> <span class="token punctuation">{</span> message<span class="token operator">:</span> message <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">8</span> <span class="token comment">/* PROPS */</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们的 render._rc 是 true 的（因为当前是 runtime compiler 版本），所以也会给 <code>withProxy</code> 属性赋值，他也是一个代理器，具体的内容我们在触发的时候再介绍。</p> <p>最后就是处理 optionsAPI 的逻辑了，这里是为了向后兼容 vue2，函数位于 packages/runtime-core/src/componentOptions.ts，它处理的就是我们在 vue2 中定义的很多 option，比如 methods，生命周期，mixins 等。我们例子中只有 data 函数，所以这里我们只分析 data 的处理逻辑：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> publicThis <span class="token operator">=</span> instance<span class="token punctuation">.</span>proxy<span class="token operator">!</span>

<span class="token function">resolveData</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> dataOptions<span class="token punctuation">,</span> publicThis<span class="token punctuation">)</span>
</code></pre></div><p>这里的 instance 是当前组件实例，dataOptions 就是我们例子中的 data 函数，publicThis 就是我们上面介绍的组件实例的 proxy 属性。来看一下 <code>resolveData</code> 的实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">resolveData</span><span class="token punctuation">(</span>
  <span class="token parameter">instance<span class="token operator">:</span> ComponentInternalInstance<span class="token punctuation">,</span>
  dataFn<span class="token operator">:</span> DataFn<span class="token punctuation">,</span>
  publicThis<span class="token operator">:</span> ComponentPublicInstance</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isFunction</span><span class="token punctuation">(</span>dataFn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">warn</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The data option must be a function. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Plain object usage is no longer supported.</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">dataFn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>publicThis<span class="token punctuation">,</span> publicThis<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> <span class="token function">isPromise</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">warn</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">data() returned a Promise - note data() cannot be async; If you </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">intend to perform data fetching before component renders, use </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">async setup() + &lt;Suspense&gt;.</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    __DEV__ <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">data() should return an object.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span>data <span class="token operator">===</span> <span class="token constant">EMPTY_OBJ</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    instance<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// existing data: this is a mixin or extends.</span>
    <span class="token function">extend</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>data<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里我保留了一些开发环境的代码，因为这里与 Vue2 有一些区别要注意。</p> <p><strong>首先，data 必须是一个函数</strong>，这点与 Vue2 不同，因为我们在 <code>new Vue</code> 的时候传入的 data 是可以是对象的，但是到了 Vue3 已经不支持了；接下来调用我们的 data 函数，注意这里传入的 publicThis 即是上下文，也是第一个参数，也就是我们的 data 函数可以这么使用：</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  methods<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">data</span><span class="token operator">:</span> <span class="token parameter">vm</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      message<span class="token operator">:</span> <span class="token string">&quot;Vue Rocks!&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>获取到 data 函数的返回值以后，接着又是一个开发环境下的提示，告诉我们 data 函数返回的不能是一个 Promise，要想实现类似的效果请使用 <strong>setup + Suspense</strong>。</p> <p>最后判断了 instance.data 是不是空对象，这个我们在上面初始化组件实例的时候说过，它的初始值是 EMPTY_OBJ，所以这里会调用 <code>reactive</code> 来将 data 函数返回值转成响应式对象，并且赋值给 instance.data 属性。响应式系统会单独在一个章节介绍，这里你就理解为，执行完这一步以后，我们的 data 函数返回值已经具有了响应式功能了。</p> <p>好了，到这里，意味着我们的 <code>finishComponentSetup</code> 差不多执行完毕了，总结一下目前的进展，其实就是给当前组件实例对象添加了很多方法和属性，比如：data，props，render 函数等，相当于是做一些准备工作。再回到 <code>mountComponent</code> 函数中，接下来要执行的也是很重要的一步：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setupRenderEffect</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> initialVNode<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> isSVG<span class="token punctuation">,</span> optimized<span class="token punctuation">)</span>
</code></pre></div><p><strong>这一步是用来设置渲染的副作用，在 Vue2 中，这一步是通过一个渲染 Watcher 来实现的，其目的就是将数据的变动与 DOM 的渲染绑定，也就是我们经常说的数据驱动。</strong> 本例中由于后几个参数用不到，所以有实际意义的就前三个，第一个是当前组件实例，第二个是初始化的 vnode，第三个是 DOM 容器。这个函数的实现比较长，我们按照实际执行做一下精简：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> setupRenderEffect<span class="token operator">:</span> <span class="token function-variable function">SetupRenderEffectFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token parameter">instance<span class="token punctuation">,</span> initialVNode<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> isSVG<span class="token punctuation">,</span> optimized</span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  instance<span class="token punctuation">.</span>update <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">componentEffect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instance<span class="token punctuation">.</span>isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> vnodeHook<span class="token operator">:</span> VNodeHook <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">|</span> <span class="token keyword">undefined</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> el<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> initialVNode
      <span class="token keyword">const</span> <span class="token punctuation">{</span> bm<span class="token punctuation">,</span> m<span class="token punctuation">,</span> parent <span class="token punctuation">}</span> <span class="token operator">=</span> instance

      <span class="token comment">// 执行组件的 beforeMount 钩子</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>bm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">invokeArrayFns</span><span class="token punctuation">(</span>bm<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 执行 VNode 的 onVnodeBeforeMount 钩子</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>vnodeHook <span class="token operator">=</span> props <span class="token operator">&amp;&amp;</span> props<span class="token punctuation">.</span>onVnodeBeforeMount<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">invokeVNodeHook</span><span class="token punctuation">(</span>vnodeHook<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> initialVNode<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 生成子树</span>
      <span class="token keyword">const</span> subTree <span class="token operator">=</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span>subTree <span class="token operator">=</span> <span class="token function">renderComponentRoot</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>el <span class="token operator">&amp;&amp;</span> hydrateNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// SSR 相关逻辑 ...</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 执行 patch，渲染到 DOM</span>
        <span class="token function">patch</span><span class="token punctuation">(</span>
          <span class="token keyword">null</span><span class="token punctuation">,</span> subTree<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> isSVG
        <span class="token punctuation">)</span>
        initialVNode<span class="token punctuation">.</span>el <span class="token operator">=</span> subTree<span class="token punctuation">.</span>el
      <span class="token punctuation">}</span>
      <span class="token comment">// 执行组件的 mounted 钩子</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">queuePostRenderEffect</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 执行 VNode 的 onVnodeMounted 钩子</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>vnodeHook <span class="token operator">=</span> props <span class="token operator">&amp;&amp;</span> props<span class="token punctuation">.</span>onVnodeMounted<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> scopedInitialVNode <span class="token operator">=</span> initialVNode
        <span class="token function">queuePostRenderEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">invokeVNodeHook</span><span class="token punctuation">(</span>vnodeHook<span class="token operator">!</span><span class="token punctuation">,</span> parent<span class="token punctuation">,</span> scopedInitialVNode<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> parentSuspense<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 处理 activated 钩子</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> a <span class="token punctuation">}</span> <span class="token operator">=</span> instance
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        a <span class="token operator">&amp;&amp;</span>
        initialVNode<span class="token punctuation">.</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">COMPONENT_SHOULD_KEEP_ALIVE</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">queuePostRenderEffect</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      instance<span class="token punctuation">.</span>isMounted <span class="token operator">=</span> <span class="token boolean">true</span>

      <span class="token comment">// #2458: deference mount-only object parameters to prevent memleaks</span>
      initialVNode <span class="token operator">=</span> container <span class="token operator">=</span> anchor <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token keyword">as</span> any
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 更新组件的逻辑 ...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> __DEV__ <span class="token operator">?</span> <span class="token function">createDevEffectOptions</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span> <span class="token operator">:</span> prodEffectOptions<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>纵观一下整个函数，实际上是给组件添加了有一个属性：<code>update</code> 函数，它的值是 <code>effect(function componentEffect(){...})</code>。这里使用 effect 注册了一个副作用函数，并且在本例中会立即执行，也就是说会执行 <code>componentEffect</code> 函数。接下来我们重点分析。</p> <p>不相干的逻辑我写在了代码注释中，这里列举出重点的主干逻辑代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> subTree <span class="token operator">=</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span>subTree <span class="token operator">=</span> <span class="token function">renderComponentRoot</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> subTree<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> isSVG<span class="token punctuation">)</span>
initialVNode<span class="token punctuation">.</span>el <span class="token operator">=</span> subTree<span class="token punctuation">.</span>el
instance<span class="token punctuation">.</span>isMounted <span class="token operator">=</span> <span class="token boolean">true</span>
initialVNode <span class="token operator">=</span> container <span class="token operator">=</span> anchor <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token keyword">as</span> any
</code></pre></div><p>首先第一步，渲染组件的子树：<code>renderComponentRoot(instance)</code>。其实上面分析的组件可以看成是 Vue 实例组件，它是根组件，这里我们就要获取它下面的子组件 Vnode，函数位于 packages/runtime-core/src/componentRenderUtils.ts 中，内容很多，但是本例中执行到到代码并不多，这里还是精简一下，不相关的逻辑用为代码表示：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">renderComponentRoot</span><span class="token punctuation">(</span>
  <span class="token parameter">instance<span class="token operator">:</span> ComponentInternalInstance</span>
<span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> Component<span class="token punctuation">,</span>
    vnode<span class="token punctuation">,</span> proxy<span class="token punctuation">,</span> withProxy<span class="token punctuation">,</span> props<span class="token punctuation">,</span> propsOptions<span class="token operator">:</span> <span class="token punctuation">[</span>propsOptions<span class="token punctuation">]</span><span class="token punctuation">,</span> slots<span class="token punctuation">,</span>
    attrs<span class="token punctuation">,</span> emit<span class="token punctuation">,</span> render<span class="token punctuation">,</span> renderCache<span class="token punctuation">,</span> data<span class="token punctuation">,</span> setupState<span class="token punctuation">,</span> ctx
  <span class="token punctuation">}</span> <span class="token operator">=</span> instance

  <span class="token keyword">let</span> result
  <span class="token comment">// 设置当前渲染的实例</span>
  currentRenderingInstance <span class="token operator">=</span> instance
  
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> fallthroughAttrs
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">STATEFUL_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     
      <span class="token keyword">const</span> proxyToUse <span class="token operator">=</span> withProxy <span class="token operator">||</span> proxy
      result <span class="token operator">=</span> <span class="token function">normalizeVNode</span><span class="token punctuation">(</span>
        render<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
          proxyToUse<span class="token punctuation">,</span>
          proxyToUse<span class="token operator">!</span><span class="token punctuation">,</span>
          renderCache<span class="token punctuation">,</span>
          props<span class="token punctuation">,</span>
          setupState<span class="token punctuation">,</span>
          data<span class="token punctuation">,</span>
          ctx
        <span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
      fallthroughAttrs <span class="token operator">=</span> attrs
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 处理函数式组件</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> root <span class="token operator">=</span> result
    <span class="token keyword">let</span> setRoot<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token operator">:</span> VNode</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> <span class="token keyword">undefined</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>Component<span class="token punctuation">.</span>inheritAttrs <span class="token operator">!==</span> <span class="token boolean">false</span> <span class="token operator">&amp;&amp;</span> fallthroughAttrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 合并 attrs ...</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>dirs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 继承指令 ...</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>transition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 继承过渡相关数据 ...</span>
    <span class="token punctuation">}</span>

    result <span class="token operator">=</span> root
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果过程中有异常，则创建一个空的注释节点</span>
    <span class="token function">handleError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">RENDER_FUNCTION</span><span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>Comment<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 重置当前渲染实例为 null</span>
  currentRenderingInstance <span class="token operator">=</span> <span class="token keyword">null</span>

  <span class="token keyword">return</span> result
<span class="token punctuation">}</span>
</code></pre></div><p>整理以后的代码很清晰，重点逻辑就是调用 render 函数来生成 vnode 那段代码，还记得我们的 render 函数是怎么来的吗？对，就是上面介绍 <code>finishComponentSetup</code> 中通过模版编译得到的，此时它返回的对象很简单：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  anchor<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  appContext<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  children<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  component<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  dirs<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  dynamicChildren<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  dynamicProps<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  el<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  key<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  patchFlag<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token comment">// 需要对 PROPS 做 patch</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>message<span class="token operator">:</span> <span class="token string">&quot;Vue Rocks!&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  ref<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  scopeId<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  shapeFlag<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token comment">// 注意此时还是有状态组件</span>
  ssContent<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  ssFallback<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  staticCount<span class="token operator">:</span> <span class="token number">0</span>
  suspense<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  target<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  targetAnchor<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  transition<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> <span class="token punctuation">{</span>template<span class="token operator">:</span> <span class="token string">&quot;&lt;h1&gt;{{ message }}&lt;/h1&gt;&quot;</span><span class="token punctuation">,</span> props<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token function-variable function">message</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  __v_isVNode<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  __v_skip<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其实通过我们的 html 模板也能看出来，当前 Vue 实例的模板下就一个子组件，即我们的 <code>hello-world</code> 组件，所以这里 <strong>得到的 subTree 就是我们这个组件了</strong>。</p> <p>最终我们返回了这个 vnode，继续回到 <code>componentEffect</code> 函数中，接下来就要调用 <code>patch</code> 函数真正的执行渲染了：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> subTree<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> isSVG<span class="token punctuation">)</span>
</code></pre></div><p>咦？等等？怎么又到 patch 了？不是一开始就 patch 了么？你还搁这 patch 什么？</p> <p>⚠️ 划重点，这里当然不同了。上一次的 patch 是我们 Vue 实例（可以看成是最外面的父组件）的 patch，这次是我们的 <code>hello-world</code> 组件的 patch，而且是往我们的父组件上 patch，所以这里我们的 instance，也就是 patch 函数的 parent 参数，是有值的，就是我们分析到现在的组件实例。</p> <p>上面跟着代码的分析你可能会不好理解，后面的流程基本跟上面的类似，为了方便阅读理解，我以流程图的形式画出来，细节部分可以参考上面的代码介绍，这里跟着图大致的过一遍剩下的流程即可：</p> <p><img src="/assets/img/02-comp-patch-flow.94ebf82a.jpg" alt="02-comp-patch-flow"></p> <p>执行完最后的 patch，我们的页面上就显示出了 Vue Rocks 的标题了，意味着组件被渲染到了页面上。随后，函数执行栈里堆积的函数们就一个个的出栈了，我们整个渲染流程也就结束了。这过程中涉及到很多函数的调用，还是递归等，建议读者也使用一个例子，逐步的打上断点加以理解。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>本节我们介绍了组件的注册和渲染。组件注册是通过 Vue 实例的 component 函数实现的，而渲染则依赖于 render 函数。render 内部会递归的调用 patch 函数来操作 vnode，生成对应的 DOM 元素，最后会调用 DOM API 来将元素挂载到页面上。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/tools/vue/vue3/01-init-app.html" class="prev">
        Vue 的初始化
      </a></span> <span class="next"><a href="/tools/vue/vue3/02-component-lifecycle.html">
        生命周期
      </a>
      →
    </span></p></div> <div class="adsense-content" data-v-5abe131a><div style="padding: 2rem 2rem 1rem 2rem" data-v-5abe131a></div></div></main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.60e74413.js" defer></script><script src="/assets/js/14.69f023c0.js" defer></script><script src="/assets/js/2.720ba71e.js" defer></script><script src="/assets/js/19.e11c0116.js" defer></script>
  </body>
</html>
