<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>锦上添花的 Modules | Jerry 个人博客</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="icon" href="/logo.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <script>
      (function() {
        var mta = document.createElement("script");
        mta.src = "//pingjs.qq.com/h5/stats.js?v2.0.4";
        mta.setAttribute("name", "MTAH5");
        mta.setAttribute("sid", "500708667");
        mta.setAttribute("cid", "500708668");
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(mta, s);
      })();
    </script>
    <script src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <meta name="description" content="Jerry's blog">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    <link rel="preload" href="/assets/css/0.styles.06744937.css" as="style"><link rel="preload" href="/assets/js/app.60e74413.js" as="script"><link rel="preload" href="/assets/js/14.69f023c0.js" as="script"><link rel="preload" href="/assets/js/2.720ba71e.js" as="script"><link rel="preload" href="/assets/js/13.fb627b38.js" as="script"><link rel="prefetch" href="/assets/js/10.4356ad27.js"><link rel="prefetch" href="/assets/js/100.c99580b9.js"><link rel="prefetch" href="/assets/js/101.356781a9.js"><link rel="prefetch" href="/assets/js/11.b045add9.js"><link rel="prefetch" href="/assets/js/12.aeedaf60.js"><link rel="prefetch" href="/assets/js/15.9fedbce0.js"><link rel="prefetch" href="/assets/js/16.1a7de72a.js"><link rel="prefetch" href="/assets/js/17.fa224a6a.js"><link rel="prefetch" href="/assets/js/18.1a72bef8.js"><link rel="prefetch" href="/assets/js/19.e11c0116.js"><link rel="prefetch" href="/assets/js/20.6a6f73dd.js"><link rel="prefetch" href="/assets/js/21.56a777d3.js"><link rel="prefetch" href="/assets/js/22.6773a84c.js"><link rel="prefetch" href="/assets/js/23.136061fb.js"><link rel="prefetch" href="/assets/js/24.7d1837f0.js"><link rel="prefetch" href="/assets/js/25.31ab58df.js"><link rel="prefetch" href="/assets/js/26.a5e7b497.js"><link rel="prefetch" href="/assets/js/27.9609abfa.js"><link rel="prefetch" href="/assets/js/28.bbb9cd06.js"><link rel="prefetch" href="/assets/js/29.8892b17d.js"><link rel="prefetch" href="/assets/js/3.b7eab624.js"><link rel="prefetch" href="/assets/js/30.74b203cc.js"><link rel="prefetch" href="/assets/js/31.f8502b39.js"><link rel="prefetch" href="/assets/js/32.4a6fdb4c.js"><link rel="prefetch" href="/assets/js/33.06378ca2.js"><link rel="prefetch" href="/assets/js/34.0060ef5f.js"><link rel="prefetch" href="/assets/js/35.1635574b.js"><link rel="prefetch" href="/assets/js/36.ba0ea7aa.js"><link rel="prefetch" href="/assets/js/37.1fe72493.js"><link rel="prefetch" href="/assets/js/38.6140df13.js"><link rel="prefetch" href="/assets/js/39.75defbda.js"><link rel="prefetch" href="/assets/js/4.99432b89.js"><link rel="prefetch" href="/assets/js/40.95f6174a.js"><link rel="prefetch" href="/assets/js/41.edc39790.js"><link rel="prefetch" href="/assets/js/42.9dcf7ed0.js"><link rel="prefetch" href="/assets/js/43.027f7ff4.js"><link rel="prefetch" href="/assets/js/44.a7fa2c02.js"><link rel="prefetch" href="/assets/js/45.3bd0a364.js"><link rel="prefetch" href="/assets/js/46.6682a04b.js"><link rel="prefetch" href="/assets/js/47.a61c377c.js"><link rel="prefetch" href="/assets/js/48.1f4bbd9a.js"><link rel="prefetch" href="/assets/js/49.7f23a237.js"><link rel="prefetch" href="/assets/js/5.406f67b1.js"><link rel="prefetch" href="/assets/js/50.2a56a559.js"><link rel="prefetch" href="/assets/js/51.bb97c3da.js"><link rel="prefetch" href="/assets/js/52.446d5740.js"><link rel="prefetch" href="/assets/js/53.e8184b0c.js"><link rel="prefetch" href="/assets/js/54.c9a5e3ed.js"><link rel="prefetch" href="/assets/js/55.97bb4c63.js"><link rel="prefetch" href="/assets/js/56.cb3d973f.js"><link rel="prefetch" href="/assets/js/57.37f3fb00.js"><link rel="prefetch" href="/assets/js/58.0d7c2f4b.js"><link rel="prefetch" href="/assets/js/59.4a2f6def.js"><link rel="prefetch" href="/assets/js/6.95b28193.js"><link rel="prefetch" href="/assets/js/60.b2a604a0.js"><link rel="prefetch" href="/assets/js/61.debbb7b9.js"><link rel="prefetch" href="/assets/js/62.0bd56b0e.js"><link rel="prefetch" href="/assets/js/63.57bf8cbe.js"><link rel="prefetch" href="/assets/js/64.41c1fb35.js"><link rel="prefetch" href="/assets/js/65.f53d1b42.js"><link rel="prefetch" href="/assets/js/66.566689b9.js"><link rel="prefetch" href="/assets/js/67.f5cf077d.js"><link rel="prefetch" href="/assets/js/68.95bc1b6c.js"><link rel="prefetch" href="/assets/js/69.bdc844a1.js"><link rel="prefetch" href="/assets/js/7.6619bfc9.js"><link rel="prefetch" href="/assets/js/70.94a6894a.js"><link rel="prefetch" href="/assets/js/71.4e9ddb06.js"><link rel="prefetch" href="/assets/js/72.2c8413d7.js"><link rel="prefetch" href="/assets/js/73.64fdac61.js"><link rel="prefetch" href="/assets/js/74.a6f66ae3.js"><link rel="prefetch" href="/assets/js/75.9e940b3a.js"><link rel="prefetch" href="/assets/js/76.7e0d8e19.js"><link rel="prefetch" href="/assets/js/77.c67342fb.js"><link rel="prefetch" href="/assets/js/78.a5bd97d1.js"><link rel="prefetch" href="/assets/js/79.3a3e3541.js"><link rel="prefetch" href="/assets/js/8.d0a8a3ed.js"><link rel="prefetch" href="/assets/js/80.97620f66.js"><link rel="prefetch" href="/assets/js/81.0d8341aa.js"><link rel="prefetch" href="/assets/js/82.0d309601.js"><link rel="prefetch" href="/assets/js/83.6123aeae.js"><link rel="prefetch" href="/assets/js/84.00b21399.js"><link rel="prefetch" href="/assets/js/85.d22ae4f9.js"><link rel="prefetch" href="/assets/js/86.a79065fe.js"><link rel="prefetch" href="/assets/js/87.01664722.js"><link rel="prefetch" href="/assets/js/88.1cb8429e.js"><link rel="prefetch" href="/assets/js/89.a36be8c5.js"><link rel="prefetch" href="/assets/js/9.f2277063.js"><link rel="prefetch" href="/assets/js/90.ebfec47e.js"><link rel="prefetch" href="/assets/js/91.47f73c78.js"><link rel="prefetch" href="/assets/js/92.4ae86837.js"><link rel="prefetch" href="/assets/js/93.8bbf0769.js"><link rel="prefetch" href="/assets/js/94.8f1e3309.js"><link rel="prefetch" href="/assets/js/95.ea1c2085.js"><link rel="prefetch" href="/assets/js/96.08475163.js"><link rel="prefetch" href="/assets/js/97.a8c7442e.js"><link rel="prefetch" href="/assets/js/98.9d7ce618.js"><link rel="prefetch" href="/assets/js/99.eb0c7f6a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.06744937.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Jerry 个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/basic/js/index.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/basic/css/index.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/basic/html/index.html" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/http/index.html" class="nav-link">
  HTTP
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue 系列" class="dropdown-title"><span class="title">Vue 系列</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tools/vue/vue2/index.html" class="nav-link">
  Vue 2
</a></li><li class="dropdown-item"><!----> <a href="/tools/vue/vue3/index.html" class="nav-link">
  Vue 3
</a></li><li class="dropdown-item"><!----> <a href="/tools/vue/vuex/index.html" class="nav-link">
  Vuex
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="源码精读" class="dropdown-title"><span class="title">源码精读</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tools/snabbdom/index.html" class="nav-link">
  Snabbdom
</a></li><li class="dropdown-item"><!----> <a href="/tools/axios/index.html" class="nav-link">
  Axios
</a></li></ul></div></div><div class="nav-item"><a href="/backend/" class="nav-link">
  技能拓展
</a></div><div class="nav-item"><a href="/tools/webpack/" class="nav-link">
  Webpack
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  About Me
</a></div> <a href="https://github.com/JerryYuanJ/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/basic/js/index.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/basic/css/index.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/basic/html/index.html" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/http/index.html" class="nav-link">
  HTTP
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue 系列" class="dropdown-title"><span class="title">Vue 系列</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tools/vue/vue2/index.html" class="nav-link">
  Vue 2
</a></li><li class="dropdown-item"><!----> <a href="/tools/vue/vue3/index.html" class="nav-link">
  Vue 3
</a></li><li class="dropdown-item"><!----> <a href="/tools/vue/vuex/index.html" class="nav-link">
  Vuex
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="源码精读" class="dropdown-title"><span class="title">源码精读</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tools/snabbdom/index.html" class="nav-link">
  Snabbdom
</a></li><li class="dropdown-item"><!----> <a href="/tools/axios/index.html" class="nav-link">
  Axios
</a></li></ul></div></div><div class="nav-item"><a href="/backend/" class="nav-link">
  技能拓展
</a></div><div class="nav-item"><a href="/tools/webpack/" class="nav-link">
  Webpack
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  About Me
</a></div> <a href="https://github.com/JerryYuanJ/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Snabbdom</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/tools/snabbdom/01-vnode.html" class="sidebar-link">什么是 VNode</a></li><li><a href="/tools/snabbdom/02-patch.html" class="sidebar-link">神奇的 patch</a></li><li><a href="/tools/snabbdom/03-modules.html" aria-current="page" class="active sidebar-link">锦上添花的 modules</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tools/snabbdom/03-modules.html#style" class="sidebar-link">style</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tools/snabbdom/03-modules.html#使用方式" class="sidebar-link">使用方式</a></li><li class="sidebar-sub-header"><a href="/tools/snabbdom/03-modules.html#源码解析" class="sidebar-link">源码解析</a></li></ul></li><li class="sidebar-sub-header"><a href="/tools/snabbdom/03-modules.html#dataset" class="sidebar-link">dataset</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tools/snabbdom/03-modules.html#使用方式-2" class="sidebar-link">使用方式</a></li><li class="sidebar-sub-header"><a href="/tools/snabbdom/03-modules.html#源码解析-2" class="sidebar-link">源码解析</a></li></ul></li><li class="sidebar-sub-header"><a href="/tools/snabbdom/03-modules.html#class" class="sidebar-link">class</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tools/snabbdom/03-modules.html#使用方式-3" class="sidebar-link">使用方式</a></li><li class="sidebar-sub-header"><a href="/tools/snabbdom/03-modules.html#源码解析-3" class="sidebar-link">源码解析</a></li></ul></li><li class="sidebar-sub-header"><a href="/tools/snabbdom/03-modules.html#props-attributes" class="sidebar-link">props &amp; attributes</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tools/snabbdom/03-modules.html#使用方式-4" class="sidebar-link">使用方式</a></li><li class="sidebar-sub-header"><a href="/tools/snabbdom/03-modules.html#源码解析-4" class="sidebar-link">源码解析</a></li></ul></li><li class="sidebar-sub-header"><a href="/tools/snabbdom/03-modules.html#eventlisteners" class="sidebar-link">eventlisteners</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tools/snabbdom/03-modules.html#使用方法" class="sidebar-link">使用方法</a></li><li class="sidebar-sub-header"><a href="/tools/snabbdom/03-modules.html#源码解析-5" class="sidebar-link">源码解析</a></li></ul></li></ul></li><li><a href="/tools/snabbdom/04-thunk.html" class="sidebar-link">优化 diff 的 thunks</a></li><li><a href="/tools/snabbdom/05-others.html" class="sidebar-link">Q&amp;A</a></li></ul></section></li></ul> <div class="adsense-content" data-v-8d82fd90><div style="padding: 2rem" data-v-8d82fd90></div></div></aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="锦上添花的-modules"><a href="#锦上添花的-modules" class="header-anchor">#</a> 锦上添花的 Modules</h1> <h2 id="style"><a href="#style" class="header-anchor">#</a> style</h2> <h3 id="使用方式"><a href="#使用方式" class="header-anchor">#</a> 使用方式</h3> <p>关于 style 的使用方式：<a href="https://github.com/snabbdom/snabbdom#the-style-module" target="_blank" rel="noopener noreferrer">snabbdom-module/style<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>我们对上一节的栗子做一些小小的修改：</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><br><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> init <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'snabbdom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> h <span class="token keyword">from</span> <span class="token string">'snabbdom/h'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> style <span class="token keyword">from</span> <span class="token string">'snabbdom/modules/style'</span>

<span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span>style<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> style<span class="token operator">:</span> <span class="token punctuation">{</span> color<span class="token operator">:</span> <span class="token string">'red'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Hello snabbdom'</span><span class="token punctuation">)</span>

<span class="token function">patch</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'container'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">patch</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> style<span class="token operator">:</span> <span class="token punctuation">{</span> color<span class="token operator">:</span> <span class="token string">'blue'</span><span class="token punctuation">,</span> fontSize<span class="token operator">:</span> <span class="token string">'20px'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Jerry'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>运行结果：</p> <img src="/assets/img/snabbdom-04-style.59031b57.gif" style="border:1px solid lightgrey;"> <h3 id="源码解析"><a href="#源码解析" class="header-anchor">#</a> 源码解析</h3> <p>首先我们先对导入的 style 模块有个基本的认识，它位于 src/modules/style.ts 中：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> styleModule<span class="token operator">:</span> Module <span class="token operator">=</span> <span class="token punctuation">{</span>
  pre<span class="token operator">:</span> forceReflow<span class="token punctuation">,</span>
  create<span class="token operator">:</span> updateStyle<span class="token punctuation">,</span>
  update<span class="token operator">:</span> updateStyle<span class="token punctuation">,</span>
  destroy<span class="token operator">:</span> applyDestroyStyle<span class="token punctuation">,</span>
  remove<span class="token operator">:</span> applyRemoveStyle
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>可以看到，它实际上就是一个包含几个钩子函数的对象。</p> <p>在上一节的 init 介绍过程中，我们提到了与模块相关的初始化，也就是在 init 的一开始：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> i<span class="token operator">:</span> number<span class="token punctuation">;</span>
<span class="token keyword">let</span> j<span class="token operator">:</span> number<span class="token punctuation">;</span>

<span class="token keyword">const</span> cbs<span class="token operator">:</span> ModuleHooks <span class="token operator">=</span> <span class="token punctuation">{</span>
  create<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  update<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  remove<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  destroy<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  pre<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  post<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> api<span class="token operator">:</span> <span class="token constant">DOMAPI</span> <span class="token operator">=</span> domApi <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> domApi <span class="token operator">:</span> htmlDomApi<span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> hooks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  cbs<span class="token punctuation">[</span>hooks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> modules<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> hook <span class="token operator">=</span> modules<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>hooks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hook <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">(</span>cbs<span class="token punctuation">[</span>hooks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token keyword">as</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中 hooks 的定义为：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> hooks<span class="token operator">:</span> Array<span class="token operator">&lt;</span>keyof Module<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'create'</span><span class="token punctuation">,</span> <span class="token string">'update'</span><span class="token punctuation">,</span> <span class="token string">'remove'</span><span class="token punctuation">,</span> <span class="token string">'destroy'</span><span class="token punctuation">,</span> <span class="token string">'pre'</span><span class="token punctuation">,</span> <span class="token string">'post'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>所以，上面的两层循环执行完以后，我们的 cbs 的结果如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  pre<span class="token operator">:</span> <span class="token punctuation">[</span>forceReflow<span class="token punctuation">]</span><span class="token punctuation">,</span>
  create<span class="token operator">:</span> <span class="token punctuation">[</span>updateStyle<span class="token punctuation">]</span><span class="token punctuation">,</span>
  update<span class="token operator">:</span> <span class="token punctuation">[</span>updateStyle<span class="token punctuation">]</span><span class="token punctuation">,</span>
  destroy<span class="token operator">:</span> <span class="token punctuation">[</span>applyDestroyStyle<span class="token punctuation">]</span><span class="token punctuation">,</span>
  remove<span class="token operator">:</span> <span class="token punctuation">[</span>applyRemoveStyle<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接着，snabbdom 会在合适的时机调用这些钩子，完成相应的功能。</p> <h4 id="pre-钩子"><a href="#pre-钩子" class="header-anchor">#</a> pre 钩子</h4> <p>结合上一节的介绍，当第一次调用 patch 的时候，我们来分析一下执行逻辑，首先是 pre 钩子：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>pre<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>pre<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>也就是会先执行我们的 <code>forceReflow</code> 方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">forceReflow</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  reflowForced <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>很简单，就是重置这个 reflowForced 标记位为 false。关于这个标记位的作用，我们待会会讲到。</p> <h4 id="create-钩子"><a href="#create-钩子" class="header-anchor">#</a> create 钩子</h4> <p>紧接着，由于是第一次调用，所以这时候执行的是 createElm 。在 <code>createElm(vnode, insertedVnodeQueue);</code> 中，我们会执行到：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>create<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>create<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>也就是会执行 updateStyle 方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">updateStyle</span> <span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> vnode<span class="token operator">:</span> VNode</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> cur<span class="token operator">:</span> any<span class="token punctuation">;</span> <span class="token comment">// 循环时使用的变量</span>
  <span class="token keyword">var</span> name<span class="token operator">:</span> string<span class="token punctuation">;</span> <span class="token comment">// 循环时使用的变量</span>
  <span class="token keyword">var</span> elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">;</span> <span class="token comment">// DOM 节点</span>
  <span class="token keyword">var</span> oldStyle <span class="token operator">=</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>data <span class="token keyword">as</span> VNodeData<span class="token punctuation">)</span><span class="token punctuation">.</span>style<span class="token punctuation">;</span> <span class="token comment">// 旧的 style</span>
  <span class="token keyword">var</span> style <span class="token operator">=</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data <span class="token keyword">as</span> VNodeData<span class="token punctuation">)</span><span class="token punctuation">.</span>style<span class="token punctuation">;</span> <span class="token comment">// 新的 style</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldStyle <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>style<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// 都没有定义的话，直接 return</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStyle <span class="token operator">===</span> style<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// 相等的话，直接 return</span>
  oldStyle <span class="token operator">=</span> oldStyle <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  style <span class="token operator">=</span> style <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> oldHasDel <span class="token operator">=</span> <span class="token string">'delayed'</span> <span class="token keyword">in</span> oldStyle<span class="token punctuation">;</span> <span class="token comment">// oldStyle 中是不是有 delayed 属性</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> oldStyle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>style<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'-'</span> <span class="token operator">&amp;&amp;</span> name<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span>elm <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>style<span class="token punctuation">.</span><span class="token function">removeProperty</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span>elm <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>style<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> style<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cur <span class="token operator">=</span> style<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">'delayed'</span> <span class="token operator">&amp;&amp;</span> style<span class="token punctuation">.</span>delayed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> name2 <span class="token keyword">in</span> style<span class="token punctuation">.</span>delayed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cur <span class="token operator">=</span> style<span class="token punctuation">.</span>delayed<span class="token punctuation">[</span>name2<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldHasDel <span class="token operator">||</span> cur <span class="token operator">!==</span> <span class="token punctuation">(</span>oldStyle<span class="token punctuation">.</span>delayed <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>name2<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">setNextFrame</span><span class="token punctuation">(</span><span class="token punctuation">(</span>elm <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>style<span class="token punctuation">,</span> name2<span class="token punctuation">,</span> cur<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">!==</span> <span class="token string">'remove'</span> <span class="token operator">&amp;&amp;</span> cur <span class="token operator">!==</span> oldStyle<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'-'</span> <span class="token operator">&amp;&amp;</span> name<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span>elm <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>style<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> cur<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span>elm <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>style<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> cur<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里的 oldVnode 是一个空的 Vnode：emptyNode，它的值为 <code>vnode('', {}, [], undefined, undefined);</code>；vnode 则是刚刚创建的：<code>h('h1', { style: { color: 'red' } }, 'Hello snabbdom')</code>。代入这两个值，我们来看看这里的流程：</p> <p>首先声明了一堆变量，接着进入第一个 for 循环：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> oldStyle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>style<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'-'</span> <span class="token operator">&amp;&amp;</span> name<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">(</span>elm <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>style<span class="token punctuation">.</span><span class="token function">removeProperty</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token punctuation">(</span>elm <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>style<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>很显然，这段逻辑的主要作用，是将 oldStyle 中有但是 style 中没有的样式或者样式属性删除。由于我们此时的 oldStyle 是个空对象，所以这段循环内的代码也不会被执行。</p> <p>接着我们来看第二段循环：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> style<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  cur <span class="token operator">=</span> style<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">'delayed'</span> <span class="token operator">&amp;&amp;</span> style<span class="token punctuation">.</span>delayed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> name2 <span class="token keyword">in</span> style<span class="token punctuation">.</span>delayed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cur <span class="token operator">=</span> style<span class="token punctuation">.</span>delayed<span class="token punctuation">[</span>name2<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldHasDel <span class="token operator">||</span> cur <span class="token operator">!==</span> <span class="token punctuation">(</span>oldStyle<span class="token punctuation">.</span>delayed <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>name2<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setNextFrame</span><span class="token punctuation">(</span><span class="token punctuation">(</span>elm <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>style<span class="token punctuation">,</span> name2<span class="token punctuation">,</span> cur<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">!==</span> <span class="token string">'remove'</span> <span class="token operator">&amp;&amp;</span> cur <span class="token operator">!==</span> oldStyle<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'-'</span> <span class="token operator">&amp;&amp;</span> name<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">(</span>elm <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>style<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> cur<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token punctuation">(</span>elm <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>style<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> cur<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里是遍历新的 style 对象，拿到每一个属性进行处理。首先判断属性的名称是不是 delayed，并且 style.delayed 有值，满足条件的话，再继续遍历这个 delayed 对象，再拿到它的每一个属性，如果 oldStyle 中没有 delayed 属性，或者当前属性的值与 oldStyle 中对应的属性的值不想等，那么执行：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setNextFrame</span><span class="token punctuation">(</span><span class="token punctuation">(</span>elm <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>style<span class="token punctuation">,</span> name2<span class="token punctuation">,</span> cur<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这个 setNextFrame 实现也很简单，就是利用浏览器的异步机制将当前属性的赋值延迟到下一次事件循环中：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> raf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> window <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>requestAnimationFrame<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> setTimeout<span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">nextFrame</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">fn<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">raf</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">raf</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> reflowForced <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">setNextFrame</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token operator">:</span> any<span class="token punctuation">,</span> prop<span class="token operator">:</span> string<span class="token punctuation">,</span> val<span class="token operator">:</span> any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token function">nextFrame</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    obj<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>由于我们这里没有 delayed 属性，所以这里执行的其实是第二个判断：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">!==</span> <span class="token string">'remove'</span> <span class="token operator">&amp;&amp;</span> cur <span class="token operator">!==</span> oldStyle<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'-'</span> <span class="token operator">&amp;&amp;</span> name<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>elm <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>style<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> cur<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>elm <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>style<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> cur<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>首先判断名称不是 remove，因为我们会对 remove 属性做特殊处理；并且这个属性 oldStyle 中没有，因为我们只操作新增的样式。满足条件的话，就进行具体的值的设置了，如果发现是样式属性的话（即 --bgColor 之类的），就调用 DOM api <code>setProperty</code> 设置这个属性和值；如果是正常的样式的话，就直接给这个样式赋值即可。对于我们的例子，应该是直接给样式赋值，也就是给这个新创建的 h1 元素的 style 属性添加一个 <code>color: red</code> 样式。</p> <p>好了，此时 updateStyle 方法介绍完了，整个流程还是很简单的，就是根据对应的条件，删除一些旧样式，添加一些新样式。</p> <h4 id="destroyed-钩子"><a href="#destroyed-钩子" class="header-anchor">#</a> destroyed 钩子</h4> <p>第一个 patch 函数的最后，我们从之前章节的介绍中了解到，还有插入新节点、移除旧节点的操作：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 先根据老的节点的位置插入新的节点，再把老的删除</span>
  api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">,</span> api<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> <span class="token punctuation">[</span>oldVnode<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们主要看 removeVnodes 的操作，它会遍历要移除的 vnodes，然后调用模块的 destroyed 钩子：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这个函数我们在 patch 这节也有过介绍，其实就是调用 vnode 的 destroy 钩子和模块的 destroy 钩子，我们来看一下这个 style 模块的 destroy 钩子函数：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">applyDestroyStyle</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token operator">:</span> VNode</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> style<span class="token operator">:</span> any<span class="token punctuation">;</span>
  <span class="token keyword">var</span> name<span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token keyword">var</span> elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">;</span>
  <span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data <span class="token keyword">as</span> VNodeData<span class="token punctuation">)</span><span class="token punctuation">.</span>style<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>style <span class="token operator">=</span> s<span class="token punctuation">.</span>destroy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> style<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>elm <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>style<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> style<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这段逻辑主要是，如果当前 vnode 没有定义 style，或者 style.destroy 的没有值的话，那么直接返回；否则遍历这个 destroy 对象，把这里面的属性赋值给当前元素的 style 的对应属性。由于我们栗子中的 vnode 没有 style，所以这里直接返回了。</p> <h4 id="remove-钩子"><a href="#remove-钩子" class="header-anchor">#</a> remove 钩子</h4> <p>接着回到 removeVnodes 中，接下来会执行到：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>remove<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>remove<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> rm<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>来执行我们模块的 remove 钩子。<strong>remove 钩子是要和 CSS Transitions 一起使用的，它会在我们删除元素时执行对应的过渡动画</strong>。我们来看看 style 对应的钩子函数的定义：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">applyRemoveStyle</span> <span class="token punctuation">(</span>vnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> <span class="token function-variable function">rm</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data <span class="token keyword">as</span> VNodeData<span class="token punctuation">)</span><span class="token punctuation">.</span>style<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s <span class="token operator">||</span> <span class="token operator">!</span>s<span class="token punctuation">.</span>remove<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">rm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reflowForced<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// eslint-disable-next-line @typescript-eslint/no-unused-expressions</span>
    <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>elm <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>offsetLeft<span class="token punctuation">;</span>
    reflowForced <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> name<span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token keyword">var</span> elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">;</span>
  <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> compStyle<span class="token operator">:</span> CSSStyleDeclaration<span class="token punctuation">;</span>
  <span class="token keyword">var</span> style <span class="token operator">=</span> s<span class="token punctuation">.</span>remove<span class="token punctuation">;</span>
  <span class="token keyword">var</span> amount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> applied<span class="token operator">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> style<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    applied<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span>elm <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>style<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> style<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  compStyle <span class="token operator">=</span> <span class="token function">getComputedStyle</span><span class="token punctuation">(</span>elm <span class="token keyword">as</span> Element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> props <span class="token operator">=</span> <span class="token punctuation">(</span>compStyle <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'transition-property'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> props<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>applied<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>props<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> amount<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">(</span>elm <span class="token keyword">as</span> Element<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'transitionend'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ev<span class="token operator">:</span> TransitionEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ev<span class="token punctuation">.</span>target <span class="token operator">===</span> elm<span class="token punctuation">)</span> <span class="token operator">--</span>amount<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>amount <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">rm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>首先这里的 rm 函数是通过 <code>createRmCb(ch.elm!, listeners)</code> 创建出来的。如果发现没有 style 或者 style 对象没有定义 remove 的话，那么直接执行这个 rm 函数后返回即可。</p> <p>接着判断 reflowForced 这个变量的值，我们在 pre 钩子中已经将它的值设为 false 了，所以这里这里要强制的<strong>回流</strong>一次，方式很简单，就是或许一个 DOM 的   offsetLeft 的值，然后将 reflowForced 设置为 true。</p> <p>然后获取 remove 属性的值，遍历这个对象，将每一个属性添加到 applied 数组中，又给这个 DOM 元素的 style 添加这个属性。</p> <p>接着又调用 <code>getComputedStyle(elm)</code> 来获取当前元素的计算样式的值 compStyle，通过这个 compStyle 来获取它的 <code>transition-property</code> 属性数组，再遍历这个数组，检查里面的元素是不是在之前定义的 applied 数组中，在的话给 amount 自增。</p> <p>最后就是给我们的 <code>transitionend</code> 添加监听事件，在动画结束的时候执行 rm() 函数。</p> <p>这里的逻辑可能解释起来比较抽象，读者可以自己写一个栗子尝试一下，就明白了这里的流程了。</p> <h4 id="update-钩子"><a href="#update-钩子" class="header-anchor">#</a> update 钩子</h4> <p>还剩一个 update 钩子函数。当我们在 setTimeout 中第二次调用 patch 的时候，会执行 patchVnode 函数，在这个函数中会执行我们的 update 钩子：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>update<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>update<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>hook<span class="token operator">?.</span>update<span class="token operator">?.</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>由于 create 和 update 钩子对应的都是 updateStyle 函数，所以这里的执行流程也是一样的，读者可以根据 create 自行理解一下这里的流程。</p> <h2 id="dataset"><a href="#dataset" class="header-anchor">#</a> dataset</h2> <h3 id="使用方式-2"><a href="#使用方式-2" class="header-anchor">#</a> 使用方式</h3> <p>我们对 style 一节对栗子添加一些代码：</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> init <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'snabbdom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> h <span class="token keyword">from</span> <span class="token string">'snabbdom/h'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> style <span class="token keyword">from</span> <span class="token string">'snabbdom/modules/style'</span>
<span class="token keyword">import</span> dataset <span class="token keyword">from</span> <span class="token string">'snabbdom/modules/dataset'</span>

<span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span>style<span class="token punctuation">,</span> dataset<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> 
  style<span class="token operator">:</span> <span class="token punctuation">{</span> color<span class="token operator">:</span> <span class="token string">'red'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> 
  dataset<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'hello-snabbdom'</span> <span class="token punctuation">}</span> 
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Hello snabbdom'</span><span class="token punctuation">)</span>

<span class="token function">patch</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'container'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">patch</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> 
    style<span class="token operator">:</span> <span class="token punctuation">{</span> color<span class="token operator">:</span> <span class="token string">'blue'</span><span class="token punctuation">,</span> fontSize<span class="token operator">:</span> <span class="token string">'20px'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> 
    dataset<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'world'</span> <span class="token punctuation">}</span> 
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Jerry'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>运行结果：</p> <img src="/assets/img/snabbdom-05-dataset.b56212a4.gif" style="border:1px solid lightgrey;"> <p>可以在调试工具的 Elements 面板中看到，一开始的元素有一个 data-name 的属性，它的值是 &quot;hello-snabbdom&quot;，三秒后变成了 &quot;world&quot;。接下来我们就来看看这个过程的实现原理。</p> <h3 id="源码解析-2"><a href="#源码解析-2" class="header-anchor">#</a> 源码解析</h3> <p>它的源码位于 src/modules/dataset 中：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>VNode<span class="token punctuation">,</span> VNodeData<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../vnode'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Module<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./module'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> type Dataset <span class="token operator">=</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> string<span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">CAPS_REGEX</span> <span class="token operator">=</span> <span class="token regex">/[A-Z]/g</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">updateDataset</span><span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> vnode<span class="token operator">:</span> VNode</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> elm<span class="token operator">:</span> HTMLElement <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm <span class="token keyword">as</span> HTMLElement<span class="token punctuation">,</span>
  oldDataset <span class="token operator">=</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>data <span class="token keyword">as</span> VNodeData<span class="token punctuation">)</span><span class="token punctuation">.</span>dataset<span class="token punctuation">,</span> <span class="token comment">// 旧的 dataset</span>
  dataset <span class="token operator">=</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data <span class="token keyword">as</span> VNodeData<span class="token punctuation">)</span><span class="token punctuation">.</span>dataset<span class="token punctuation">,</span> <span class="token comment">// 新的 dataset</span>
  key<span class="token operator">:</span> string<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldDataset <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>dataset<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// 都没有定义的话，直接返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldDataset <span class="token operator">===</span> dataset<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// 相等的话，直接返回</span>
  oldDataset <span class="token operator">=</span> oldDataset <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  dataset <span class="token operator">=</span> dataset <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> d <span class="token operator">=</span> elm<span class="token punctuation">.</span>dataset<span class="token punctuation">;</span> <span class="token comment">// 真实 DOM 元素上的 dataset</span>

  <span class="token comment">// 遍历旧的 dataset</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> oldDataset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 新的里面没有这个 key</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dataset<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果 DOM 元素有 dataset 的话，直接操作这个 dataset 对象，删除掉这个 key</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> d<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">delete</span> d<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 否则调用 DOM API 来删除这个 dataset 的 key</span>
        elm<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token string">'data-'</span> <span class="token operator">+</span> key<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">CAPS_REGEX</span><span class="token punctuation">,</span> <span class="token string">'-$&amp;'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 遍历新的 dataset</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> dataset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 对应某个key的值，新旧不相等</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldDataset<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> dataset<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果 DOM 元素有 dataset 的话，那么直接操作这个 dataset 对象，给它添加属性即可</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        d<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> dataset<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 否则利用 DOM API 添加这个属性的值</span>
        elm<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'data-'</span> <span class="token operator">+</span> key<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">CAPS_REGEX</span><span class="token punctuation">,</span> <span class="token string">'-$&amp;'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dataset<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> datasetModule <span class="token operator">=</span> <span class="token punctuation">{</span>create<span class="token operator">:</span> updateDataset<span class="token punctuation">,</span> update<span class="token operator">:</span> updateDataset<span class="token punctuation">}</span> <span class="token keyword">as</span> Module<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> datasetModule<span class="token punctuation">;</span>
</code></pre></div><p>它导出了两个钩子：create 和 update，这两个钩子都指向同一个函数：updateDataset。这个函数的实现也非常的简单，两个循环就搞定了。详细解释都在代码注释中了，大致流程是：第一个循环，删除不用的 dataset 属性，第二个循环，添加新增的 dataset 属性。其中，如果能通过 DOM 获取到 dataset 对象的话，说明这个元素已经定义了 dataset，那么直接操作这个对象即可，<strong>对这个对象的修改会实时的反应到 DOM 上。</strong></p> <h2 id="class"><a href="#class" class="header-anchor">#</a> class</h2> <h3 id="使用方式-3"><a href="#使用方式-3" class="header-anchor">#</a> 使用方式</h3> <p>我们继续修改上面的栗子，添加我们的 class 模块</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><br><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> init <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'snabbdom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> h <span class="token keyword">from</span> <span class="token string">'snabbdom/h'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> style <span class="token keyword">from</span> <span class="token string">'snabbdom/modules/style'</span>
<span class="token keyword">import</span> dataset <span class="token keyword">from</span> <span class="token string">'snabbdom/modules/dataset'</span>
<span class="token keyword">import</span> klass <span class="token keyword">from</span> <span class="token string">'snabbdom/modules/class'</span>

<span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span>style<span class="token punctuation">,</span> dataset<span class="token punctuation">,</span> klass<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> 
  style<span class="token operator">:</span> <span class="token punctuation">{</span> color<span class="token operator">:</span> <span class="token string">'red'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> 
  dataset<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'hello-snabbdom'</span> <span class="token punctuation">}</span> <span class="token punctuation">,</span>
  <span class="token keyword">class</span><span class="token operator">:</span> <span class="token punctuation">{</span> darkBg<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Hello snabbdom'</span><span class="token punctuation">)</span>

<span class="token function">patch</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'container'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">patch</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> 
    style<span class="token operator">:</span> <span class="token punctuation">{</span> color<span class="token operator">:</span> <span class="token string">'blue'</span><span class="token punctuation">,</span> fontSize<span class="token operator">:</span> <span class="token string">'20px'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> 
    dataset<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'world'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">class</span><span class="token operator">:</span> <span class="token punctuation">{</span> darkBg<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Jerry'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>还要在我们的 index.html 中添加一个样式：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
  <span class="token selector">.darkBg</span><span class="token punctuation">{</span>
    <span class="token property">background-color</span><span class="token punctuation">:</span> grey<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>运行结果：</p> <img src="/assets/img/snabbdom-06-class.6036b989.gif" style="border:1px solid lightgrey;"> <p>可以看到，一开始的 h1 是有灰色背景色的，三秒后就没有了。我们来看一下它背后的实现原理。</p> <h3 id="源码解析-3"><a href="#源码解析-3" class="header-anchor">#</a> 源码解析</h3> <p>源码位于 src/modules/class.ts 中：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>VNode<span class="token punctuation">,</span> VNodeData<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../vnode'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Module<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./module'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> type Classes <span class="token operator">=</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> boolean<span class="token operator">&gt;</span>

<span class="token keyword">function</span> <span class="token function">updateClass</span><span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> vnode<span class="token operator">:</span> VNode</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> cur<span class="token operator">:</span> any<span class="token punctuation">,</span> name<span class="token operator">:</span> string<span class="token punctuation">,</span> elm<span class="token operator">:</span> Element <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm <span class="token keyword">as</span> Element<span class="token punctuation">,</span>
      oldClass <span class="token operator">=</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>data <span class="token keyword">as</span> VNodeData<span class="token punctuation">)</span><span class="token punctuation">.</span>class<span class="token punctuation">,</span>
      klass <span class="token operator">=</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data <span class="token keyword">as</span> VNodeData<span class="token punctuation">)</span><span class="token punctuation">.</span>class<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldClass <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>klass<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldClass <span class="token operator">===</span> klass<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  oldClass <span class="token operator">=</span> oldClass <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  klass <span class="token operator">=</span> klass <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> oldClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>klass<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 删除旧的中有，而新的中没有的样式</span>
      elm<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> klass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 新样式的值</span>
    cur <span class="token operator">=</span> klass<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果新旧样式的值不相等的话，比如我们栗子中的 darkBg，一个是 false，一个是 true</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">!==</span> oldClass<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 根据 cur 的值来确定我们是 新增 还是 删除 这个样式</span>
      <span class="token punctuation">(</span>elm<span class="token punctuation">.</span>classList <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>cur <span class="token operator">?</span> <span class="token string">'add'</span> <span class="token operator">:</span> <span class="token string">'remove'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> classModule <span class="token operator">=</span> <span class="token punctuation">{</span>create<span class="token operator">:</span> updateClass<span class="token punctuation">,</span> update<span class="token operator">:</span> updateClass<span class="token punctuation">}</span> <span class="token keyword">as</span> Module<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> classModule<span class="token punctuation">;</span>
</code></pre></div><p>首先，看一下他的导出的 classModule 依然是只有 create 和 update 钩子，并且两者指向同一个函数：updateClass。这个函数的实现也非常的简单，与我们上面介绍的 dataset 非常类似，也是通过两个 for 循环解决问题。第一个循环，删除了不需要的样式；第二个循环，针对新样式对象中的值来删除或者新增某些样式。</p> <h2 id="props-attributes"><a href="#props-attributes" class="header-anchor">#</a> props &amp; attributes</h2> <p>由于这两个实现基本类似，所以我放到了一起，仅以 props 为例。</p> <p>关于 properties 和 attributes 的区别，可以参考这一篇文章：<a href="https://stackoverflow.com/questions/6003819/what-is-the-difference-between-properties-and-attributes-in-html/6004028" target="_blank" rel="noopener noreferrer">what-is-the-difference-between-properties-and-attributes-in-html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="使用方式-4"><a href="#使用方式-4" class="header-anchor">#</a> 使用方式</h3> <p>老样子，根据上一节的栗子，我们添加 props 和 attributes 的代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> init <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'snabbdom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> h <span class="token keyword">from</span> <span class="token string">'snabbdom/h'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> style <span class="token keyword">from</span> <span class="token string">'snabbdom/modules/style'</span>
<span class="token keyword">import</span> dataset <span class="token keyword">from</span> <span class="token string">'snabbdom/modules/dataset'</span>
<span class="token keyword">import</span> klass <span class="token keyword">from</span> <span class="token string">'snabbdom/modules/class'</span>
<span class="token keyword">import</span> props <span class="token keyword">from</span> <span class="token string">'snabbdom/modules/props'</span>
<span class="token keyword">import</span> attr <span class="token keyword">from</span> <span class="token string">'snabbdom/modules/attributes'</span>

<span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span>style<span class="token punctuation">,</span> dataset<span class="token punctuation">,</span> klass<span class="token punctuation">,</span> props<span class="token punctuation">,</span> attr<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> 
  style<span class="token operator">:</span> <span class="token punctuation">{</span> color<span class="token operator">:</span> <span class="token string">'red'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> 
  dataset<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'hello-snabbdom'</span> <span class="token punctuation">}</span> <span class="token punctuation">,</span>
  <span class="token keyword">class</span><span class="token operator">:</span> <span class="token punctuation">{</span> darkBg<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token string">'foo'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  attrs<span class="token operator">:</span> <span class="token punctuation">{</span> myAttr<span class="token operator">:</span> <span class="token string">'foo'</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Hello snabbdom'</span><span class="token punctuation">)</span>

<span class="token function">patch</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'container'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">patch</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> 
    style<span class="token operator">:</span> <span class="token punctuation">{</span> color<span class="token operator">:</span> <span class="token string">'blue'</span><span class="token punctuation">,</span> fontSize<span class="token operator">:</span> <span class="token string">'20px'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> 
    dataset<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'world'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">class</span><span class="token operator">:</span> <span class="token punctuation">{</span> darkBg<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token string">'bar'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    attrs<span class="token operator">:</span> <span class="token punctuation">{</span> myAttr<span class="token operator">:</span> <span class="token string">'zoo'</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Jerry'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>运行结果：</p> <img src="/assets/img/snabbdom-07-props.8f7a5b7a.gif" style="border:1px solid lightgrey;"> <p>可以观察一下调试工具里的元素，它的 id 属性和 myAttr 特性前后都发生了变化。</p> <h3 id="源码解析-4"><a href="#源码解析-4" class="header-anchor">#</a> 源码解析</h3> <p>它们的源码位于 src/modules/props.ts 和 src/modules/attributes.ts 中，这里我们分析 props 的实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>VNode<span class="token punctuation">,</span> VNodeData<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../vnode'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Module<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./module'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> type Props <span class="token operator">=</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> any<span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">updateProps</span><span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> vnode<span class="token operator">:</span> VNode</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> key<span class="token operator">:</span> string<span class="token punctuation">,</span> cur<span class="token operator">:</span> any<span class="token punctuation">,</span> old<span class="token operator">:</span> any<span class="token punctuation">,</span> elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span>
      oldProps <span class="token operator">=</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>data <span class="token keyword">as</span> VNodeData<span class="token punctuation">)</span><span class="token punctuation">.</span>props<span class="token punctuation">,</span>
      props <span class="token operator">=</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data <span class="token keyword">as</span> VNodeData<span class="token punctuation">)</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldProps <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>props<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldProps <span class="token operator">===</span> props<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  oldProps <span class="token operator">=</span> oldProps <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  props <span class="token operator">=</span> props <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> oldProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>props<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> <span class="token punctuation">(</span>elm <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cur <span class="token operator">=</span> props<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    old <span class="token operator">=</span> oldProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>old <span class="token operator">!==</span> cur <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token string">'value'</span> <span class="token operator">||</span> <span class="token punctuation">(</span>elm <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> cur<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">(</span>elm <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> cur<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> propsModule <span class="token operator">=</span> <span class="token punctuation">{</span>create<span class="token operator">:</span> updateProps<span class="token punctuation">,</span> update<span class="token operator">:</span> updateProps<span class="token punctuation">}</span> <span class="token keyword">as</span> Module<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> propsModule<span class="token punctuation">;</span>
</code></pre></div><p>它导出了 create 和 udpate 钩子，两个钩子也是同一个函数：updateProps。它的实现也非常简单，就是删除旧的 props，增加新的 props。其实这里的实现跟 jQuery 的 prop() 方法很像，这里不多做赘述了。</p> <p>关于 attributes 的实现，它与 props 不同的是，它使用 setAttribute 和 removeAttribute 来设置和删除属性，并且还考虑到了命名空间（setAttributeNS）的问题。</p> <h2 id="eventlisteners"><a href="#eventlisteners" class="header-anchor">#</a> eventlisteners</h2> <p>eventlisteners 模块提供了非常强大的功能让我们可以为元素绑定事件，我们这一小节就来看看它的用法和原理。</p> <h3 id="使用方法"><a href="#使用方法" class="header-anchor">#</a> 使用方法</h3> <p>我们添加一些事件绑定的代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> init <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'snabbdom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> h <span class="token keyword">from</span> <span class="token string">'snabbdom/h'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> style <span class="token keyword">from</span> <span class="token string">'snabbdom/modules/style'</span>
<span class="token keyword">import</span> dataset <span class="token keyword">from</span> <span class="token string">'snabbdom/modules/dataset'</span>
<span class="token keyword">import</span> klass <span class="token keyword">from</span> <span class="token string">'snabbdom/modules/class'</span>
<span class="token keyword">import</span> props <span class="token keyword">from</span> <span class="token string">'snabbdom/modules/props'</span>
<span class="token keyword">import</span> attr <span class="token keyword">from</span> <span class="token string">'snabbdom/modules/attributes'</span>
<span class="token keyword">import</span> eventlisteners <span class="token keyword">from</span> <span class="token string">'snabbdom/modules/eventlisteners'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span>style<span class="token punctuation">,</span> dataset<span class="token punctuation">,</span> klass<span class="token punctuation">,</span> props<span class="token punctuation">,</span> attr<span class="token punctuation">,</span> eventlisteners<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">clickBefore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'click before'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">clickAfter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'click after'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  style<span class="token operator">:</span> <span class="token punctuation">{</span> color<span class="token operator">:</span> <span class="token string">'red'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  dataset<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'hello-snabbdom'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">class</span><span class="token operator">:</span> <span class="token punctuation">{</span> darkBg<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token string">'foo'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  attrs<span class="token operator">:</span> <span class="token punctuation">{</span> myAttr<span class="token operator">:</span> <span class="token string">'foo'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  on<span class="token operator">:</span> <span class="token punctuation">{</span>
    click<span class="token operator">:</span> clickBefore
  <span class="token punctuation">}</span>  
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Hello snabbdom'</span><span class="token punctuation">)</span>

<span class="token function">patch</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'container'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">patch</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    style<span class="token operator">:</span> <span class="token punctuation">{</span> color<span class="token operator">:</span> <span class="token string">'blue'</span><span class="token punctuation">,</span> fontSize<span class="token operator">:</span> <span class="token string">'20px'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    dataset<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'world'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">class</span><span class="token operator">:</span> <span class="token punctuation">{</span> darkBg<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token string">'bar'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    attrs<span class="token operator">:</span> <span class="token punctuation">{</span> myAttr<span class="token operator">:</span> <span class="token string">'zoo'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    on<span class="token operator">:</span> <span class="token punctuation">{</span>
      click<span class="token operator">:</span> clickAfter
    <span class="token punctuation">}</span>  
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Jerry'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>我们定义了两个事件：clickBefore 和 clickAfter，然后分别赋值给旧的和新的 vnode。看一下运行效果：</p> <img src="/assets/img/snabbdom-08-event.cc21ba0b.gif" style="border:1px solid lightgrey;"> <p>一开始我们点击的时候，控制台打印的是 “click before”，三秒后再次点击，打印的是 “click after”。接下来我们来看看它是如何实现的。</p> <h3 id="源码解析-5"><a href="#源码解析-5" class="header-anchor">#</a> 源码解析</h3> <p>源码位于 src/modules/eventlisteners.ts 中，它的代码相对较多，我们逐步拆解的来看。</p> <p>首先看一下导出的部分：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> eventListenersModule <span class="token operator">=</span> <span class="token punctuation">{</span>
  create<span class="token operator">:</span> updateEventListeners<span class="token punctuation">,</span>
  update<span class="token operator">:</span> updateEventListeners<span class="token punctuation">,</span>
  destroy<span class="token operator">:</span> updateEventListeners
<span class="token punctuation">}</span> <span class="token keyword">as</span> Module<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> eventListenersModule<span class="token punctuation">;</span>
</code></pre></div><p>它导出了三个钩子函数：create，update 和 destroy，不过它们三个都指向同一个 updateEventListeners 函数，我们就先来看看这个函数的实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">updateEventListeners</span><span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> vnode<span class="token operator">?</span><span class="token operator">:</span> VNode</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> oldOn <span class="token operator">=</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>data <span class="token keyword">as</span> VNodeData<span class="token punctuation">)</span><span class="token punctuation">.</span>on<span class="token punctuation">,</span>
      oldListener <span class="token operator">=</span> <span class="token punctuation">(</span>oldVnode <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>listener<span class="token punctuation">,</span>
      oldElm<span class="token operator">:</span> Element <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm <span class="token keyword">as</span> Element<span class="token punctuation">,</span>
      on <span class="token operator">=</span> vnode <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data <span class="token keyword">as</span> VNodeData<span class="token punctuation">)</span><span class="token punctuation">.</span>on<span class="token punctuation">,</span>
      elm<span class="token operator">:</span> Element <span class="token operator">=</span> <span class="token punctuation">(</span>vnode <span class="token operator">&amp;&amp;</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span> <span class="token keyword">as</span> Element<span class="token punctuation">,</span>
      name<span class="token operator">:</span> string<span class="token punctuation">;</span>

  <span class="token comment">// optimization for reused immutable handlers</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldOn <span class="token operator">===</span> on<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// remove existing listeners which no longer used</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldOn <span class="token operator">&amp;&amp;</span> oldListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// if element changed or deleted we remove all existing listeners unconditionally</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>on<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> oldOn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// remove listener if element was changed or existing listeners removed</span>
        oldElm<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> oldListener<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> oldOn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// remove listener if existing listener removed</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>on<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          oldElm<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> oldListener<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// add new listeners which has not already attached</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>on<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// reuse existing listener or create new</span>
    <span class="token keyword">var</span> listener <span class="token operator">=</span> <span class="token punctuation">(</span>vnode <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>listener <span class="token operator">=</span> <span class="token punctuation">(</span>oldVnode <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>listener <span class="token operator">||</span> <span class="token function">createListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// update vnode for listener</span>
    listener<span class="token punctuation">.</span>vnode <span class="token operator">=</span> vnode<span class="token punctuation">;</span>

    <span class="token comment">// if element changed or added we add all needed listeners unconditionally</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldOn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> on<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// add listener if element was changed or new listeners added</span>
        elm<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> listener<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> on<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// add listener if new listener added</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldOn<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          elm<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> listener<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码逻辑很清晰，作者的注释也写的很详细，我们一点点来看。首先它先拿到了旧的 oldOn 对象和 oldElm 对象以及新的 on 和 elm 对象，这其中还有一个 <code>oldListener = (oldVnode as any).listener,</code>，你也许会很奇怪，我们的 Vnode 接口中明明没有定义这个 listener 属性啊。不要急，下面的分析会说到这个属性的由来。</p> <p>接着判断了 oldOn 与 on 是不是同一个对象，如果是的话，那么也没必要做任何事了，直接返回即可。</p> <p>继续往下，碰到第一个 if 分支，先判断 oldOn 和 oldListener 有没有值，如果都有的话，再判断 on 有没有值，如果 on 没有值的话，那么意味着这时候元素上要么被修改了，要么被删除了，那么之前它上面绑定的事件监听函数也没什么用了，所以就删除 oldOn 中所有的事件监听函数；如果 on 有值的话，那么我们就删除 oldOn 中有、但是 on 中没有的事件监听函数。</p> <p>然后第二个 if 是判断 on 存不存在，如果存在的话，首先执行这两行：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// reuse existing listener or create new</span>
<span class="token keyword">var</span> listener <span class="token operator">=</span> <span class="token punctuation">(</span>vnode <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>listener <span class="token operator">=</span> <span class="token punctuation">(</span>oldVnode <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>listener <span class="token operator">||</span> <span class="token function">createListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// update vnode for listener</span>
listener<span class="token punctuation">.</span>vnode <span class="token operator">=</span> vnode<span class="token punctuation">;</span>
</code></pre></div><p>是的，这里就是给我们 vnode 的 listener 属性赋值，也就是函数一开始获取的那个 oldListener 最原始的由来。如果旧的 vnode 有这个属性的话，就重用它；否则调用 createListener 创建一个监听函数。在第一个 patch 函数执行的时候，oldVnode.listener 肯定是 Falsy 的，所以这里会执行 createListener，我们来看一下它的实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token operator">:</span> Event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">handleEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token punctuation">(</span>handler <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>它返回一个 handler 函数，函数内部调用了 handleEvent 方法，它接受两个参数，一个是事件对象，一个是 handler.vnode。我们知道，事件对象在运行时会赋值为对应的 DOM 事件，但是这个 handler.vnode 是从哪里来的呢？</p> <p>它其实是后赋值的，也就是在执行完 createListener 后的这行代码：<code>listener.vnode = vnode;</code>。</p> <p>好了，我们来看一下这个 handleEvent 函数吧：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">handleEvent</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token operator">:</span> Event<span class="token punctuation">,</span> vnode<span class="token operator">:</span> VNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> name <span class="token operator">=</span> event<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
      on <span class="token operator">=</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data <span class="token keyword">as</span> VNodeData<span class="token punctuation">)</span><span class="token punctuation">.</span>on<span class="token punctuation">;</span>

  <span class="token comment">// call event handler(s) if exists</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>on <span class="token operator">&amp;&amp;</span> on<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">invokeHandler</span><span class="token punctuation">(</span>on<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其实也就是做了简单的判断，看这个事件处理函数存不存在，存在的话就调用 invokeHandler 执行，它接受三个参数：事件处理函数、vnode 和 DOM 事件对象，其中后两个是可选的。来看一下 invokeHandler 的实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">invokeHandler</span><span class="token punctuation">(</span><span class="token parameter">handler<span class="token operator">:</span> any<span class="token punctuation">,</span> vnode<span class="token operator">?</span><span class="token operator">:</span> VNode<span class="token punctuation">,</span> event<span class="token operator">?</span><span class="token operator">:</span> Event</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> handler <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// call function handler</span>
    <span class="token function">handler</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> event<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> handler <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// call handler with arguments</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> handler<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// special case for single argument for performance</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>handler<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        handler<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> handler<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> event<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> args <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        args<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        args<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        handler<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// call multiple handlers</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> handler<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">invokeHandler</span><span class="token punctuation">(</span>handler<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里主要是对我们事件的统一处理了。首先我们要了解，在 on 中，事件处理可以这么写：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 第一个参数是 name, 后面两个是 snabbdom 为你添加了，一个是事件对象，一个是 vnode 对象</span>
<span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> event<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// handle click with name &amp; event &amp; vnode</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">handleOther</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// handle others</span>
<span class="token punctuation">}</span>

on<span class="token operator">:</span> <span class="token punctuation">{</span>
  mouseover<span class="token operator">:</span> handleOther<span class="token punctuation">,</span> <span class="token comment">// case1: 最简单的使用</span>
  click<span class="token operator">:</span> <span class="token punctuation">[</span>handleClick<span class="token punctuation">,</span> <span class="token string">'Jerry'</span><span class="token punctuation">]</span> <span class="token comment">// case2: ‘Jerry’ 作为 handleClick 的第一个参数</span>
  mousedown<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>handleClick<span class="token punctuation">,</span> <span class="token string">'Jerry'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Hello!!'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> handleOther<span class="token punctuation">]</span> <span class="token comment">// case3: 可以定义多个处理事件</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于这五花八门的写法，都是在这个 invokeHandler 中做处理的。</p> <p>首先，如果 handle 是一个函数，也就是这种情况：<code>mouseover: handleOther,</code> 下，那么直接调用这个函数：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 可以看到，执行 handler 的时候，它的两个参数一个是 event 一个是 vnode</span>
<span class="token function">handler</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> event<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>否则，如果这个 handler 是个对象的话，判断它的第一项是不是函数，如果是的话，执行以下逻辑：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> handler<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// special case for single argument for performance</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>handler<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    handler<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> handler<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> event<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> args <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    args<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    args<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    handler<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里判断了 <code>handler[0]</code> 是不是一个函数，是的话，判断 handler 的 length，如果是 2 的话，就直接调用函数 <code>handler[0].call(vnode, handler[1], event, vnode);</code>，否则取出所有的参数，再拼接上 event 和 vnode后调用 <code>handler[0].apply(vnode, args);</code>。这里判断 <code>handler.length === 2</code> 的目的，是出于性能考虑。我们的这个栗子：<code>click: [handleClick, 'Jerry']</code> ，就是满足了 length === 2 的条件。</p> <p>如果不满足 <code>typeof handler[0] === &quot;function&quot;</code> 条件的话，也就是我们的 case3 的栗子了：</p> <div class="language- extra-class"><pre class="language-text"><code>mousedown: [[handleClick, 'Jerry'], () =&gt; alert('Hello!!'), handleOther]
</code></pre></div><p>（因为这个时候 <code>typeof handler[0]</code> 的值为 &quot;object&quot;，所以不满足条件）。这个时候就遍历这个 handler 对象，递归的调用 invokeHandler：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> handler<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">invokeHandler</span><span class="token punctuation">(</span>handler<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样我们每一个函数就都会在事件触发时被执行。</p> <p>好了，createListener 介绍完了，再回到我们的 updateEventListeners 上来，之后做的就很明朗了：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// if element changed or added we add all needed listeners unconditionally</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldOn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> on<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// add listener if element was changed or new listeners added</span>
    elm<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> listener<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> on<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// add listener if new listener added</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldOn<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      elm<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> listener<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其实就是根据具体的条件添加事件处理函数了：如果之前没有定义 oldOn，那么添加这个新的 on 中所有的监听函数；如果之前有，那么我们就添加之前没有添加过的。就是这么简单！</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">7/7/2020, 11:46:30 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/tools/snabbdom/02-patch.html" class="prev">
        神奇的 patch
      </a></span> <span class="next"><a href="/tools/snabbdom/04-thunk.html">
        优化 diff 的 thunks
      </a>
      →
    </span></p></div> <div class="adsense-content" data-v-5abe131a><div style="padding: 2rem 2rem 1rem 2rem" data-v-5abe131a></div></div></main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.60e74413.js" defer></script><script src="/assets/js/14.69f023c0.js" defer></script><script src="/assets/js/2.720ba71e.js" defer></script><script src="/assets/js/13.fb627b38.js" defer></script>
  </body>
</html>
